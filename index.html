<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Chat OS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #07c160;
            --bg-grey: #f2f2f2;
            --border: #e5e5e5;
            --bubble-right: #95ec69;
            --bubble-left: #fff;
            --red: #fa5151;
            --pink: #ff758c;
            --pink-bg: #ffeef1;
            --link: #576b95;
            --text-main: #111;
            --text-sub: #777;
            --radius-box: 12px;
            --radius-btn: 6px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: #000; height: 100vh; display: flex; justify-content: center; align-items: center; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", Arial, sans-serif; overflow: hidden; margin: 0; }
        
        #device { width: 100%; height: 100%; background: #fff; position: relative; overflow: hidden; border: none; border-radius: 0; box-shadow: none; }
        .hidden { display: none !important; }
        
        /* Toast */
        #toast { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: #fff; padding: 10px 20px; border-radius: 8px; font-size: 14px; z-index: 9999; display: none; text-align: center; }
        
        /* Status Bar */
        .status-bar { height: 44px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; font-weight: 600; font-size: 15px; position: absolute; top: 0; width: 100%; z-index: 9000; pointer-events: none; color: #000; }
        .status-right { display: flex; gap: 6px; align-items: center; }
        .battery-icon { width: 22px; height: 11px; border: 1px solid #000; border-radius: 3px; position: relative; }
        .battery-level { width: 80%; height: 100%; background: #000; }
        /* Nav & Containers */
        .page { width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: #fff; display: none; flex-direction: column; padding-top: 0; }
        .page.active { display: flex !important; }
        
        /* Layers (Apps) */
        .layer { position: absolute; top: 0; left: 100%; width: 100%; height: 100%; background: #efeff4; transition: left 0.3s; z-index: 5000; display: flex; flex-direction: column; }
        .layer.show { left: 0; }
        
        /* Nav Bar */
        .nav-bar { height: 44px; background: #ededed; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #d1d1d1; font-size: 17px; position: relative; z-index: 100; flex-shrink: 0; margin-top: 44px; }
        .nav-title { font-weight: 600; font-size: 17px; color: var(--text-main); position: absolute; left: 50%; transform: translateX(-50%); white-space: nowrap; }
        .nav-icon { font-size: 20px; padding: 10px; cursor: pointer; color: var(--text-main); z-index: 2; min-width: 40px; text-align: center; }
        
        .scroll-y { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; -webkit-overflow-scrolling: touch; }
        
        /* Desktop */
        #desktop { background: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?auto=format&fit=crop&w=800&q=80') center/cover; padding-top: 60px; }
        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px 15px; padding: 25px; }
        .app-item { display: flex; flex-direction: column; align-items: center; color: #fff; cursor: pointer; }
        .app-icon { width: 60px; height: 60px; border-radius: 14px; display: flex; justify-content: center; align-items: center; font-size: 30px; margin-bottom: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.1s; background-size: cover; background-position: center; position: relative; }
        .app-icon:active { transform: scale(0.95); }
        .app-name { font-size: 12px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); font-weight: 500; }
        /* Chat UI */
        .msg-row { display: flex; gap: 10px; padding: 10px 15px; position: relative; flex-shrink: 0; }
        .msg-row.me { flex-direction: row-reverse; }
        .bubble { background: var(--bubble-left); padding: 10px 14px; border-radius: 8px; font-size: 16px; line-height: 1.5; word-wrap: break-word; border: 1px solid #e5e5e5; max-width: 240px; position: relative; min-height: 40px; }
        .bubble.loading { display: flex; align-items: center; justify-content: center; gap: 4px; min-width: 60px; }
        .dot { width: 8px; height: 8px; background: #bbb; border-radius: 50%; animation: dot-blink 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes dot-blink { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .msg-row.me .bubble { background: var(--bubble-right); border-color: #8ad863; }
        .bubble img { max-width: 140px; max-height: 200px; border-radius: 4px; display: block; }
        .bubble.voice { display: flex; align-items: center; gap: 5px; cursor: pointer; min-width: 80px; }
        .bubble-transfer { width: 235px; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative; display: flex; flex-direction: column; box-shadow: 0 1px 2px rgba(0,0,0,0.05); background: #f79c45; }
        .bubble-transfer.done { background: #f9e1c4; opacity: 0.9; }
        .transfer-top { padding: 16px 12px; display: flex; align-items: center; gap: 12px; color: #fff; min-height: 72px; }
        .transfer-icon { width: 42px; height: 42px; border-radius: 50%; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }
        .transfer-info { display: flex; flex-direction: column; justify-content: center; flex: 1; }
        .transfer-amt { font-size: 17px; font-weight: 500; margin-bottom: 2px; }
        .transfer-desc { font-size: 13px; opacity: 0.9; }
        .transfer-bottom { background: #fff; padding: 8px 12px; font-size: 11px; color: #999; border-top: 1px solid #f5f5f5; display: flex; align-items: center; gap: 5px; opacity: 0.8; }
        .bubble-transfer.done .transfer-bottom { background: #fff; opacity: 0.6; }
        
        .bubble-transfer-status { background: #fff; padding: 12px; border-radius: 8px; width: 230px; font-size: 14px; color: #999; display: flex; align-items: center; gap: 8px; border: 1px solid #e5e5e5; }
        .bubble-location { background: #fff; border-radius: 8px; width: 240px; overflow: hidden; border: 1px solid #e5e5e5; padding: 0; display: flex; flex-direction: column; }
        .loc-map { height: 120px; background: url('https://api.mapbox.com/styles/v1/mapbox/streets-v11/static/121.47,31.23,12,0/400x200?access_token=pk.eyJ1IjoiZXhhbXBsZSIsImEiOiJja2xsbmN5ZGMwMzBzMm1tZ3Z5cmZ5b3poIn0.example') center/cover; background-color: #eee; position: relative; }
        .loc-map::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 20px; height: 20px; background: red; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .loc-info { padding: 10px 12px; }
        .loc-name { font-size: 16px; font-weight: 500; color: #333; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .loc-addr { font-size: 12px; color: #999; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .bubble.selected { background: #d4d4d4; }
        /* Input Bar */
        .input-bar { background: #f7f7f7; border-top: 1px solid #d1d1d1; padding: 8px 5px 20px 5px; display: flex; flex-direction: column; position: relative; z-index: 5001; }
        .quote-preview { background: #ededed; padding: 8px 12px; font-size: 13px; color: #666; border-left: 3px solid #ccc; margin-bottom: 5px; display: none; justify-content: space-between; align-items: center; border-radius: 4px; }
        .input-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; height: 36px; }
        .input-field { flex: 1; height: 36px; border: 1px solid #ddd; border-radius: 4px; padding: 0 8px; font-size: 15px; background: #fff; min-width: 0; }
        .voice-hold-btn { flex: 1; height: 36px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; background: #fff; font-weight: bold; display: none; align-items: center; justify-content: center; cursor: pointer; }
        .btn-act { padding: 0 8px; height: 32px; border-radius: 4px; border: none; font-size: 13px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 500; white-space: nowrap; }
        .btn-gen { background: linear-gradient(135deg, #7F7FD5, #91EAE4); color: #fff; font-size: 12px; }
        .btn-thought { background: #ff9a9e; font-size: 12px; }
        .btn-send { background: var(--primary); }
        .toolbar { display: flex; justify-content: space-around; padding: 2px 0; color: #555; font-size: 22px; }
        .toolbar i { padding: 10px; cursor: pointer; position: relative; z-index: 5002; }

        /* New Offline Chat Styles */
        .offline-chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .offline-msg-box {
            width: 100%;
            background: var(--bubble-left);
            border: 1px solid var(--border);
            border-radius: var(--radius-box);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .offline-msg-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #f9f9f9;
            border-bottom: 1px solid var(--border);
        }
        .offline-msg-header.user {
            background: #e1ffc7; /* A light green to distinguish user */
        }
        .offline-sender {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        .offline-sender .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
        }
        .offline-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: var(--text-sub);
        }
        .offline-meta .edit-icon {
            cursor: pointer;
        }
        .offline-msg-body {
            padding: 15px;
            font-size: 16px;
            line-height: 1.6;
            word-wrap: break-word;
            white-space: pre-wrap; /* To respect newlines from AI */
        }
        .offline-input-bar {
            background: #f7f7f7;
            border-top: 1px solid #d1d1d1;
            padding: 8px 10px 20px 10px; /* Add bottom padding for home indicator area */
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .offline-input-bar input {
            flex: 1;
            height: 38px;
            border: 1px solid #ddd;
            border-radius: var(--radius-btn);
            padding: 0 10px;
            font-size: 16px;
        }

        /* Popups */
        .pop-menu { position: absolute; z-index: 6000; background: #4c4c4c; border-radius: 8px; padding: 0; display: none; flex-direction: row; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); white-space: nowrap; }
        .pop-opt { color: #fff; padding: 10px 15px; font-size: 14px; border-right: 1px solid #5d5d5d; cursor: pointer; }
        .pop-opt:last-child { border: none; }
        
        .contact-menu { position: absolute; z-index: 6000; background: #4c4c4c; border-radius: 8px; padding: 5px 0; display: none; flex-direction: column; min-width: 120px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .contact-menu-item { color: #fff; padding: 12px 20px; font-size: 15px; border-bottom: 1px solid #5d5d5d; cursor: pointer; text-align: center; }
        .contact-menu-item:last-child { border: none; }
        
        .add-menu { position: absolute; top: 50px; right: 10px; width: 160px; background: #4c4c4c; border-radius: 8px; display: none; flex-direction: column; z-index: 6100; }
        .add-item { color: #fff; padding: 12px 15px; border-bottom: 1px solid #5d5d5d; font-size: 15px; display: flex; gap: 10px; align-items: center; cursor: pointer; }
        .sticker-panel { height: 180px; background: #f2f2f2; overflow-y: auto; padding: 10px; display: none; grid-template-columns: repeat(4, 1fr); gap: 10px; border-top: 1px solid #ddd; }
        .sticker-item { font-size: 28px; background: #fff; border-radius: 8px; display: flex; justify-content: center; align-items: center; height: 60px; cursor: pointer; object-fit: contain; overflow: hidden; }
        .sticker-item img { width: 100%; height: 100%; object-fit: contain; }
        .sticker-layout { display: flex; height: 100%; }
        .sticker-sidebar { width: 80px; background: #f7f7f7; border-right: 1px solid #eee; display: flex; flex-direction: column; overflow-y: auto; }
        .sticker-cate-tab { padding: 15px 5px; text-align: center; font-size: 13px; color: #666; cursor: pointer; border-bottom: 1px solid #f0f0f0; word-break: break-all; }
        .sticker-cate-tab.active { background: #fff; color: var(--primary); border-left: 3px solid var(--primary); font-weight: bold; }
        .sticker-content { flex: 1; background: #fff; padding: 10px; overflow-y: auto; }
        /* Settings & Forms */
        .group-box { background: #fff; margin-bottom: 12px; border-radius: var(--radius-box); overflow: hidden; margin: 10px; }
        .form-cell { display: flex; align-items: center; padding: 14px; border-bottom: 1px solid #f5f5f5; font-size: 16px; cursor: pointer; position: relative; }
        .form-label { flex: 1; color: var(--text-main); }
        .form-val { color: var(--text-sub); font-size: 15px; max-width: 60%; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .switch { position: relative; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 100%; height: 100%; position: absolute; z-index: 10; cursor: pointer; top:0; left:0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; pointer-events: none; }
        .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Lists */
        .list-item { display: flex; align-items: center; padding: 15px; background: #fff; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .avatar { width: 48px; height: 48px; border-radius: 8px; object-fit: cover; background: #eee; flex-shrink: 0; }
        .list-content { flex: 1; margin-left: 14px; }
        .list-title { font-size: 17px; font-weight: 500; }
        .list-sub { font-size: 14px; color: var(--text-sub); margin-top: 4px; }

        .wb-category-bar { display: flex; overflow-x: auto; background: #fff; padding: 10px; gap: 10px; border-bottom: 1px solid #eee; white-space: nowrap; }
        .wb-cate-chip { padding: 4px 12px; background: #f2f2f2; border-radius: 16px; font-size: 13px; color: #666; cursor: pointer; }
        .wb-cate-chip.active { background: var(--primary); color: #fff; }

        /* Couple App New Style */
        .couple-pink-header { height: 60vh; background: var(--pink); color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; transition: height 0.3s; }
        .couple-days-num { font-size: 72px; font-weight: bold; margin: 10px 0; text-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; }
        .couple-card { background: #fff; margin: -50px 20px 20px; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(255, 117, 140, 0.2); position: relative; z-index: 10; min-height: 200px; }
        
        /* Other Apps */
        .weather-card { background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%); color: #fff; padding: 20px; border-radius: 12px; margin: 15px; position: relative; }
        .phone-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; }
        .phone-card { background: #fff; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; aspect-ratio: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .full-btn { width: 90%; margin: 20px 5%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .red { background: var(--red); }
        
        /* Phone Check UI Specifics */
        .phone-chat-time { text-align: center; font-size: 12px; color: #999; margin: 15px 0 5px; }
        .memo-item { background: #fff9c4; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #fbc02d; cursor: pointer; }
        .memo-title { font-weight: bold; font-size: 16px; margin-bottom: 5px; color: #333; }
        .memo-date { font-size: 12px; color: #888; }
        .memo-detail-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff9c4; z-index: 6100; padding: 20px; display: none; flex-direction: column; }
        .browser-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: #fff; }
        .browser-icon { width: 36px; height: 36px; background: #f2f2f2; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 12px; color: #999; }
        .browser-info { flex: 1; overflow: hidden; }
        .browser-query { font-size: 16px; color: #333; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .browser-url { font-size: 12px; color: #999; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .fake-input-bar { height: 50px; background: #f7f7f7; border-top: 1px solid #d1d1d1; display: flex; align-items: center; padding: 0 10px; gap: 10px; flex-shrink: 0; }
        .fake-input { flex: 1; height: 36px; background: #fff; border-radius: 4px; border: 1px solid #ddd; }
        .fake-icon { font-size: 24px; color: #7f7f7f; }
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 8000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #fff; width: 85%; border-radius: 16px; overflow: hidden; max-height: 80%; overflow-y: auto; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .img-preview-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .img-preview-box { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: auto; }
        .img-preview-box img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s; }
        
        .wx-tab-bar { height: 50px; border-top: 1px solid #d1d1d1; display: flex; align-items: center; background: #f7f7f7; position: absolute; bottom: 0; width: 100%; z-index: 600; }
        .nav-tab { flex: 1; text-align: center; color: #999; font-size: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; height: 100%; cursor: pointer; }
        .nav-tab i { font-size: 20px; margin-bottom: 2px; }
        .nav-tab.active { color: #07c160; }
        
        /* Loading Spinner */
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 9999; display: none; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); border-left-color: var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Global Music Player */
        #global-music-player { position: fixed; bottom: 60px; left: 0; right: 0; height: 60px; background: linear-gradient(to right, #ff9a9e, #fecfef); display: none; align-items: center; padding: 0 15px; z-index: 7000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .music-info { flex: 1; color: #fff; overflow: hidden; }
        .music-title { font-size: 14px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .music-controls { display: flex; gap: 15px; align-items: center; color: #fff; font-size: 20px; }
        .music-controls i { cursor: pointer; }</style>
</head>
<body>
    <div id="device">
        <input type="file" id="import-file" class="hidden" accept=".json" onchange="handleImport(this)">
        <div id="toast">提示</div>
        <div id="loading"><div class="spinner"></div></div>
        <!-- Status Bar -->
        <div class="status-bar">
            <div id="clock">12:00</div>
            <div class="status-right">
                <i class="fas fa-signal"></i>
                <i class="fas fa-wifi"></i>
                <div class="battery-icon"><div class="battery-level"></div></div>
            </div>
        </div>

        <!-- Global Music Player -->
        <div id="global-music-player">
            <div class="music-info">
                <div class="music-title" id="current-music-title">未播放</div>
            </div>
            <div class="music-controls">
                <i class="fas fa-backward" onclick="prevMusic()"></i>
                <i class="fas fa-play" id="play-pause-btn" onclick="togglePlay()"></i>
                <i class="fas fa-forward" onclick="nextMusic()"></i>
                <i class="fas fa-times" onclick="closeMusic()"></i>
            </div>
            <audio id="global-audio" onended="nextMusic()"></audio>
        </div>
        
        <audio id="tts-audio" class="hidden"></audio>

        <!-- LAYERS -->
        <div id="layer-desktop" class="page active">
            <div id="desktop" class="scroll-y">
                <div class="app-grid" id="desktop-grid"></div>
            </div>
        </div>

        <!-- WECHAT -->
        <div id="layer-wechat" class="page">
            <div id="wx-content-area" style="position:absolute; top:0; bottom:50px; width:100%; overflow:hidden;">
                <!-- Tab Contacts -->
                <div id="tab-contacts" class="page active" style="padding-top:44px;">
                    <div class="nav-bar" style="position:absolute; top:0; width:100%; margin-top:44px;">
                        <div class="nav-icon" onclick="exitApp()"><i class="fas fa-chevron-left"></i></div>
                        <div class="nav-title">微信</div>
                        <div class="nav-icon" onclick="toggleAddMenu(event)"><i class="fas fa-plus-circle"></i></div>
                </div>
                    <div class="add-menu" id="wx-add-menu">
                        <div class="add-item" onclick="openContactModal()"><i class="fas fa-user-plus"></i> 添加朋友</div>
                        <div class="add-item" style="border:none;" onclick="gotoAddGroup()"><i class="fas fa-users"></i> 发起群聊</div>
                    </div>
                    <div id="contact-list" class="scroll-y" style="padding-top:44px;"></div>
                </div>
                
                <!-- Tab Moments -->
                <div id="tab-moments" class="page" style="padding-top:0;">
                    <div class="nav-bar" style="background:transparent; border:none; position:absolute; top:44px; width:100%; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.5); margin-top:0; z-index:200;">
                        <div class="nav-icon" onclick="exitApp()"><i class="fas fa-chevron-left"></i></div>
                        <div class="nav-title"></div>
                        <div class="nav-icon" onclick="showMomentActionSheet()"><i class="fas fa-camera"></i></div>
                    </div>
                    <div id="moments-feed" class="scroll-y" style="background:#fff;"></div>
                </div>

                <!-- Tab Me -->
                <div id="tab-me" class="page" style="padding-top:44px;">
                     <div class="scroll-y" style="background:#f2f2f2;"><div style="background:#fff; padding:30px 20px; display:flex; gap:15px; align-items:center; margin-top:20px;" onclick="openProfileEdit()">
                            <img id="my-avatar" class="avatar" style="width:64px; height:64px;" onclick="event.stopPropagation(); uploadImg('my-avatar')">
                            <div style="flex:1;"><h2 id="my-name" style="font-size:20px; font-weight:600;">User</h2><p style="color:#777; font-size:13px;">微信号:<span id="my-wxid">wxid_123</span></p></div>
                <i class="fas fa-chevron-right" style="color:#ccc;"></i>
                        </div>
                        <div class="group-box">
                            <div class="list-item" onclick="openWallet()"><i class="fas fa-wallet" style="color:#eda338; font-size:22px; margin-right:12px;"></i><div class="list-content"><div class="list-title">钱包</div><div class="list-sub" id="wallet-balance"></div></div></div>
                        </div>
                        <div class="group-box">
                            <div class="form-cell"><span class="form-label"><b>朋友圈AI互评</b></span><div class="switch"><input type="checkbox" id="ai-moment-interaction" onchange="toggleAiMomentInteraction(this.checked)"><span class="slider"></span></div></div>
                        </div>
                         <div class="group-box">
                            <div class="list-item" onclick="openDiary()"><i class="fas fa-book" style="color:#9b59b6; font-size:22px; margin-right:12px;"></i><div class="list-content"><div class="list-title">日记本</div></div></div>
                            <div class="list-item" onclick="openPersonaMgmt()"><i class="fas fa-address-card" style="color:#1296db; font-size:22px; margin-right:12px;"></i><div class="list-content"><div class="list-title">多重人设</div></div></div>
                <div class="list-item" onclick="openStickerGallery()"><i class="fas fa-icons" style="color:#f6c02d; font-size:22px; margin-right:12px;"></i><div class="list-content"><div class="list-title">表情包图库</div></div></div><div class="list-item" onclick="openMusic()"><i class="fas fa-music" style="color:#2dcc70; font-size:22px; margin-right:12px;"></i><div class="list-content"><div class="list-title">一起听歌</div></div></div>
                        </div></div>
                </div>
            </div>

            <!-- Bottom Tab Bar -->
            <div class="wx-tab-bar">
                <div class="nav-tab active" onclick="switchTab(0, this)"><i class="fas fa-comment"></i><span>微信</span></div>
                <div class="nav-tab" onclick="switchTab(1, this)"><i class="fas fa-compass"></i><span>发现</span></div>
                <div class="nav-tab" onclick="switchTab(2, this)"><i class="fas fa-user"></i><span>我</span></div>
            </div>
        </div>

        <!-- CHAT ROOM -->
        <div id="layer-chat" class="layer" style="display:flex; flex-direction:column; height:100%;">
            <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-chat')"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title" id="chat-title">Chat</div>
                <div class="nav-icon" onclick="openChatSettings()"><i class="fas fa-ellipsis-h"></i></div>
            </div>
            
            <div id="chat-select-bar" style="background:#f7f7f7; padding:10px; display:none; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; flex-shrink:0;">
                <div onclick="cancelSelect()">取消</div>
                <div onclick="deleteSelected()">删除</div></div>

            <div id="chat-history" style="flex:1; overflow-y:auto; background:#ededed; padding-bottom:10px;" onclick="dismissPopups()"></div>
            
            <div id="msg-menu" class="pop-menu">
                <div class="pop-opt" onclick="menuQuote()">引用</div>
                <div class="pop-opt" onclick="menuCopy()">复制</div>
                <div class="pop-opt" onclick="menuEdit()">编辑</div>
                <div class="pop-opt" onclick="menuSelect()">多选</div>
                <div class="pop-opt" onclick="menuDelete()">删除</div>
            </div>

            <div class="input-bar" style="flex-shrink:0;">
                <div id="quote-preview" class="quote-preview">
                    <span id="quote-text"></span>
                    <i class="fas fa-times" onclick="cancelQuote()"></i>
                </div>
                <div class="input-row">
                    <button class="btn-act btn-gen" onclick="aiGenerate()">生成</button>
                    <input id="chat-input" class="input-field" onkeypress="if(event.key==='Enter'){userSend('text')}"><div id="voice-hold-btn" class="voice-hold-btn" onmousedown="startVoice()" onmouseup="endVoice()" ontouchstart="startVoice()" ontouchend="endVoice()">按住说话</div>
                    <button class="btn-act btn-thought" onclick="showThought()">心声</button>
                    <button class="btn-act btn-send" onclick="userSend('text')">发送</button>
                </div>
                <div class="toolbar">
                    <i class="fas fa-microphone" onclick="openCustomInput('voice-fake')"></i>
                    <i class="far fa-image" onclick="openCustomInput('image-fake')"></i>
                    <i class="fas fa-camera" onclick="uploadImg('send-photo')"></i>
                    <i class="fas fa-wallet" onclick="openCustomInput('transfer')"></i>
                    <i class="far fa-smile" onclick="userSend('emoji')"></i>
                    <i class="fas fa-map-marker-alt" onclick="openCustomInput('location')"></i>
                    <i class="fas fa-redo" onclick="aiRetry()"></i>
                    <i class="fas fa-plus-circle" onclick="togglePopup('ext-menu')"></i>
                </div>
            </div>
            <div id="sticker-panel" class="sticker-panel"></div>
            <div id="ext-menu" class="add-menu" style="bottom:60px; top:auto; right:10px;">
                <div class="add-item" onclick="openOfflineMode()"><i class="fas fa-feather-alt"></i> 线下模式</div>
                <div class="add-item" onclick="openOnlineMode()"><i class="fas fa-pen"></i> 线上模式</div>
                <div class="add-item" onclick="toast('暂未开放')" style="opacity:0.6;"><i class="fas fa-phone-alt"></i> 语音通话</div>
                <div class="add-item" onclick="toast('暂未开放')" style="opacity:0.6;"><i class="fas fa-video"></i> 视频通话</div>
            </div>
        </div>

        <!-- ADD GROUP CHAT -->
        <div id="layer-add-group" class="layer">
            <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-add-group')">取消</div>
                <div class="nav-title">选择联系人</div>
                <div class="nav-icon" style="color:var(--primary); font-size: 16px; font-weight: 600;" onclick="confirmCreateGroup()">完成</div>
            </div>
            <div id="add-group-contact-list" class="scroll-y" style="background:#fff;"></div>
        </div>

        <!-- DIARY -->
        <div id="layer-diary" class="layer">
            <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-diary')"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title">日记本</div>
                <div class="nav-icon" onclick="showDiaryGenerateModal()"><i class="fas fa-plus"></i></div>
            </div>
            <div class="scroll-y" style="background:#f2f2f2; padding:15px;" id="diary-grid"></div>
        </div>

        <!-- DIARY LIST (Formerly Detail) -->
        <div id="layer-diary-detail" class="layer" style="z-index:6000;">
            <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-diary-detail')"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title" id="diary-detail-name">日记</div>
                <div class="nav-icon" onclick="openCustomInput('new-diary')"><i class="fas fa-edit"></i></div>
            </div>
            <div class="scroll-y" style="background:#f2f2f2; padding:15px;" id="diary-detail-content"></div>
        </div>

        <!-- DIARY READ (Single Entry) -->
        <div id="layer-diary-read" class="layer" style="z-index:6100;">
            <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-diary-read')"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title">日记详情</div>
                <div class="nav-icon" onclick="togglePopup('diary-read-menu')"><i class="fas fa-ellipsis-h"></i></div>
            </div>
            <div class="add-menu" id="diary-read-menu" style="top:44px; right:10px;">
                <div class="add-item" onclick="editCurrentDiary()"><i class="fas fa-edit"></i> 编辑</div>
                <div class="add-item" onclick="deleteCurrentDiary()" style="color:#fa5151; border:none;"><i class="fas fa-trash"></i> 删除</div>
            </div>
            <div class="scroll-y" style="background:#fff; padding:25px;" id="diary-read-body"></div>
        </div>

        <!-- OTHER APPS -->
        <div id="layer-chat-settings" class="layer">
             <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-chat-settings')"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title">聊天设置</div></div>
            <div class="scroll-y" style="background:#f2f2f2; padding-top:20px;">
                <div id="chat-settings-content"></div>
                <div style="margin:20px 10px;">
                    <button class="full-btn" onclick="saveChatSettings()">保存</button>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="full-btn" style="background:#ccc; flex:1;" onclick="pinContactToggle()" id="btn-pin-contact">置顶</button>
                        <button class="full-btn red" style="flex:1;" onclick="deleteContactFromSettings()">删除联系人</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="layer-worldbook" class="layer">
            <div class="nav-bar">
                <div class="nav-icon" onclick="exitApp()"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title">世界书</div>
                <div class="nav-icon" onclick="toggleWBMenu(event)"><i class="fas fa-plus"></i></div>
            </div>
            <div class="add-menu" id="wb-add-menu" style="top:88px;">
                <div class="add-item" onclick="openWBModal()"><i class="fas fa-book"></i> 新建世界书</div>
                <div class="add-item" onclick="openCategoryModal()" style="border:none;"><i class="fas fa-folder-plus"></i> 创建分类</div>
            </div>
            <div id="wb-category-bar" class="wb-category-bar"></div>
            <div class="scroll-y" style="background:#f2f2f2; padding:15px;" id="wb-list"></div>
        </div>

        <div id="layer-wallet" class="layer">
            <div class="nav-bar" style="background:#eda338; border:none; color:#fff;"><div class="nav-icon" onclick="closeLayer('layer-wallet')" style="color:#fff;"><i class="fas fa-chevron-left"></i></div><div class="nav-title" style="color:#fff;">钱包</div></div>
            <div class="scroll-y" style="background:#ededed;">
                <div style="background:#eda338; height:150px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff;">
                    <div style="opacity:0.8;">余额</div>
                    <div style="font-size:36px; font-weight:bold;">￥<span id="wallet-amt">0.00</span></div>
                </div>
                <button class="full-btn" onclick="openCustomInput('recharge')">充值</button>
                <div class="group-box" id="wallet-bill"></div>
            </div>
        </div>
        <div id="layer-online-mode" class="layer">
             <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-online-mode')">取消</div><div class="nav-title">线上模式</div><div class="nav-icon" style="color:var(--primary);" onclick="sendOnlineMode()">发送</div></div>
             <div style="padding:20px; flex:1; display:flex; flex-direction:column;"><textarea id="online-text" style="flex:1; border:none; outline:none; font-size:16px; line-height:1.5; resize:none;" placeholder="在此输入长文..."></textarea>
             </div>
        </div>

        <!-- OFFLINE MODE -->
        <div id="layer-offline-mode" class="layer">
             <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-offline-mode')"><i class="fas fa-chevron-left"></i> 返回</div>
                <div class="nav-title">线下模式</div>
                <div class="nav-icon" onclick="openOfflineSettings()"><i class="fas fa-cog"></i></div>
             </div>
             <div id="offline-chat-history" class="offline-chat-history">
                <!-- Messages will be injected here by JS -->
             </div>
             <div class="offline-input-bar">
                <button class="btn-act" onclick="regenerateOfflineReply()" style="background:#f39c12;">重新生成</button>
                <input id="offline-chat-input" placeholder="输入内容..." onkeypress="if(event.key==='Enter'){sendOfflineMessage()}">
                <button class="btn-act btn-send" onclick="sendOfflineMessage()">发送</button>
             </div>
        </div>
        
        <!-- Offline Settings Modal -->
        <div id="modal-offline-settings" class="modal-mask">
            <div class="modal-box">
                <h3>线下模式设置</h3>
                <div class="group-box" style="margin-top:15px;">
                    <div class="form-cell">
                        <span class="form-label">交互模式</span>
                        <select id="offline-mode-type" class="form-val" style="border:none; text-align:right;">
                            <option value="page">独立页面</option>
                            <option value="float" disabled>悬浮球 (暂未开放)</option>
                        </select>
                    </div>
                    <div class="form-cell">
                        <span class="form-label">字数范围</span>
                        <div>
                            <input id="offline-min-words" type="number" value="300" style="width:60px; text-align:center; border:1px solid #ddd; border-radius:4px; padding:5px;">
                            <span>-</span>
                            <input id="offline-max-words" type="number" value="1000" style="width:60px; text-align:center; border:1px solid #ddd; border-radius:4px; padding:5px;">
                        </div>
                    </div>
                    <div class="form-cell">
                        <span class="form-label">文本风格</span>
                        <select id="offline-style" class="form-val" style="border:none; text-align:right;">
                            <option value="故事化">故事化</option>
                            <option value="文艺">文艺</option>
                            <option value="简练">简练</option>
                            <option value="散文">散文</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex; justify-content:flex-end; margin-top:20px;">
                    <button onclick="document.getElementById('modal-offline-settings').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px; margin-right:10px;">取消</button>
                    <button onclick="saveOfflineSettings()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
                </div>
            </div>
        </div>

        <div id="layer-couple" class="layer">
             <div id="couple-content-area" style="height:100%; display:flex; flex-direction:column;"></div>
        </div>

        <div id="layer-perception" class="layer">
             <div class="nav-bar"><div class="nav-icon" onclick="exitApp()"><i class="fas fa-chevron-left"></i></div><div class="nav-title">感知</div></div>
             <div class="scroll-y" style="background:#f2f2f2; padding:15px;">
                 <div class="weather-card">
                     <div style="font-size:36px; font-weight:bold;" id="perc-weather-temp">26°C</div>
                     <div id="perc-weather">晴朗</div>
                     <div style="margin-top:10px; opacity:0.8;" id="perc-loc">上海</div>
                     <i class="fas fa-sync" style="position:absolute; top:20px; right:20px; cursor:pointer;" onclick="calibrateWeather()"></i>
                 </div>
                 <div class="group-box">
                    <div class="form-cell"><span class="form-label"><b>全局感知总开关</b></span><div class="switch"><input type="checkbox" id="perc-master" onchange="savePerception()"><span class="slider"></span></div></div>
                 </div>

                 <h3 style="margin:15px 5px; font-size:14px; color:#555;">全局虚拟设定 (覆盖现实)</h3>
                 <div class="group-box">
                    <div class="form-cell">
                        <span class="form-label">虚拟日期</span>
                        <div class="switch" style="margin-right:10px;"><input type="checkbox" id="perc-custom-date" onchange="savePerception()"><span class="slider"></span></div>
                        <input type="date" id="perc-date-val" class="form-val" style="border:none;" onchange="savePerception()">
                    </div>
                    <div class="form-cell">
                        <span class="form-label">虚拟时间</span>
                        <div class="switch" style="margin-right:10px;"><input type="checkbox" id="perc-custom-time" onchange="savePerception()"><span class="slider"></span></div>
                        <input type="time" id="perc-time-val" class="form-val" style="border:none;" onchange="savePerception()">
                    </div>
                    <div class="form-cell" style="flex-direction:column; align-items:flex-start;">
                         <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <span class="form-label">虚拟地点</span>
                            <div class="switch"><input type="checkbox" id="perc-custom-city" onchange="savePerception()"><span class="slider"></span></div>
                         </div>
                         <div style="width:100%; display:flex; gap:5px;">
                             <input id="perc-city-val" placeholder="虚拟城市 (AI认知)" style="flex:1; padding:5px; border:1px solid #ddd; border-radius:4px;" onchange="savePerception()">
                             <input id="perc-real-city-val" placeholder="真实城市 (查天气)" style="flex:1; padding:5px; border:1px solid #ddd; border-radius:4px;" onchange="savePerception()">
                         </div>
                    </div>
                    <div class="form-cell">
                        <span class="form-label">虚拟天气</span>
                        <div class="switch" style="margin-right:10px;"><input type="checkbox" id="perc-custom-weather" onchange="savePerception()"><span class="slider"></span></div>
                        <input id="perc-weather-val" placeholder="如: 下雪" class="form-val" style="border:none; text-align:right;" onchange="savePerception()">
                    </div>
                    <div class="form-cell">
                        <span class="form-label">虚拟气候</span>
                        <div class="switch" style="margin-right:10px;"><input type="checkbox" id="perc-custom-climate" onchange="savePerception()"><span class="slider"></span></div>
                        <span class="form-val" id="perc-climate-val" onclick="if(document.getElementById('perc-custom-climate').checked) picker('climate')">点击选择</span>
                    </div>
                 </div>
                 <h3 style="margin:15px 5px;">节日</h3>
                 <div class="group-box" id="festival-list"></div>
                 <button class="full-btn" onclick="openCustomInput('festival')">添加节日</button>
             </div>
        </div>

        <div id="layer-checkphone" class="layer">
             <div class="nav-bar"><div class="nav-icon" onclick="exitCheckPhone()"><i class="fas fa-chevron-left"></i></div><div class="nav-title">查手机</div></div>
             <div class="scroll-y" style="background:#f2f2f2;" id="checkphone-container">
                 <div style="text-align:center; padding:50px; color:#999;">
                     <i class="fas fa-mobile-alt" style="font-size:64px; margin-bottom:20px; color:#ccc;"></i>
                     <div>请先选择要查看的联系人</div>
                     <button onclick="selectCheckPhoneContact()" style="margin-top:20px; padding:10px 25px; background:var(--primary); color:#fff; border:none; border-radius:6px; font-size:16px;">选择联系人</button>
                 </div>
             </div>
        </div>
        <!-- Check Phone Selector Modal -->
        <div id="modal-checkphone-contact" class="modal-mask"><div class="modal-box">
            <h3>选择要查看的手机</h3>
            <div id="checkphone-contact-list" style="max-height:300px; overflow-y:auto; margin-top:10px;"></div>
            <div style="padding:15px; text-align:center; border-top:1px solid #eee; margin-top:10px;" onclick="document.getElementById('modal-checkphone-contact').style.display='none'">取消</div>
        </div></div>

        <!-- Phone Check Sub-layers -->
        <div id="layer-phone-contacts" class="layer" style="z-index:6000;">
            <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-phone-contacts')"><i class="fas fa-chevron-left"></i></div><div class="nav-title">联系人</div><div class="nav-icon" onclick="refreshPhoneData('contacts')"><i class="fas fa-sync"></i></div></div>
            <div id="phone-contacts-list" class="scroll-y" style="background:#f2f2f2;"></div>
        </div>

        <div id="layer-phone-chat" class="layer" style="z-index:6100; display:flex; flex-direction:column;">
            <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-phone-chat')"><i class="fas fa-chevron-left"></i></div><div class="nav-title" id="phone-chat-title"></div><div class="nav-icon"><i class="fas fa-ellipsis-h"></i></div></div>
            <div id="phone-chat-history" class="scroll-y" style="background:#ededed; padding-bottom:20px; flex:1;"></div>
            <div class="fake-input-bar">
                <i class="fas fa-wifi fake-icon" style="transform: rotate(90deg);"></i>
                <div class="fake-input"></div>
                <i class="far fa-smile fake-icon"></i>
                <i class="fas fa-plus-circle fake-icon"></i>
            </div>
        </div>

        <div id="layer-phone-memo" class="layer" style="z-index:6000;">
            <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-phone-memo')"><i class="fas fa-chevron-left"></i></div><div class="nav-title">备忘录</div><div class="nav-icon" onclick="refreshPhoneData('memo')"><i class="fas fa-sync"></i></div></div>
            <div id="phone-memo-list" class="scroll-y" style="background:#fff; padding:15px;"></div>
            <div id="phone-memo-detail" class="memo-detail-view">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:10px;">
                    <i class="fas fa-chevron-left" style="font-size:20px; cursor:pointer;" onclick="document.getElementById('phone-memo-detail').style.display='none'"></i>
                    <i class="fas fa-trash" style="font-size:18px; opacity:0.5;"></i>
                </div>
                <div id="memo-det-title" style="font-size:22px; font-weight:bold; margin-bottom:10px;"></div>
                <div id="memo-det-date" style="font-size:14px; color:#888; margin-bottom:20px;"></div>
                <div id="memo-det-content" style="font-size:16px; line-height:1.6; white-space:pre-wrap;"></div>
            </div>
        </div>

        <div id="layer-phone-search" class="layer" style="z-index:6000;">
            <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-phone-search')"><i class="fas fa-chevron-left"></i></div><div class="nav-title">搜索记录</div><div class="nav-icon" onclick="refreshPhoneData('search')"><i class="fas fa-sync"></i></div></div>
            <div id="phone-search-list" class="scroll-y" style="background:#fff;"></div>
        </div>
        
        <div id="layer-phone-usage" class="layer" style="z-index:6000;">
             <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-phone-usage')"><i class="fas fa-chevron-left"></i></div><div class="nav-title">使用情况</div></div>
             <div class="scroll-y" style="background:#f2f2f2; padding:20px;" id="phone-usage-content"></div>
        </div>

        <div id="layer-settings" class="layer">
             <div class="nav-bar"><div class="nav-icon" onclick="exitApp()"><i class="fas fa-chevron-left"></i></div><div class="nav-title">设置</div></div>
             <div class="scroll-y" style="background:#f2f2f2; padding:20px;">
                 <h3 style="margin-bottom:10px;">API 预设</h3>
                 <div class="group-box" id="api-preset-list"></div>
                 <button class="full-btn" onclick="openAPIPresetModal()">添加预设</button>
                
                 <h3 style="margin:20px 010px;">当前配置</h3>
                 <div class="group-box"><div class="form-cell" style="flex-direction:column; align-items:flex-start;"><span class="form-label" style="margin-bottom:10px;">API Endpoint</span><input id="sys-url" style="width:100%; padding:10px; border:1px solid #eee; border-radius:6px;" placeholder="https://api.openai.com/v1"></div>
                    <div class="form-cell" style="flex-direction:column; align-items:flex-start;"><span class="form-label" style="margin-bottom:10px;">API Key</span><input id="sys-key" type="password" style="width:100%; padding:10px; border:1px solid #eee; border-radius:6px;"></div>
                 </div>
                 <button class="full-btn" onclick="fetchModels()">拉取模型</button>
                 <div class="group-box"><div class="form-cell"><span class="form-label">模型</span><select id="sys-model" style="border:none; background:transparent; text-align:right;"><option>gpt-3.5-turbo</option></select></div></div>
                 
                 <h3 style="margin:20px 0 10px;">MiniMax 配置</h3>
                 <div class="group-box">
                     <div class="form-cell" style="flex-direction:column; align-items:flex-start; border-bottom: none;"><span class="form-label" style="margin-bottom:10px;">TTS API Key & Group ID</span><input id="sys-minimax-key" type="password" style="width:100%; padding:10px; border:1px solid #eee; border-radius:6px;" placeholder="格式: APIKey,GroupID"></div>
                 </div>
                 <button class="full-btn" onclick="saveSysSettings()">保存配置</button>
                 <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="full-btn" onclick="exportData()" style="background:#5856d6; margin:0;">导出数据</button>
                    <button class="full-btn" onclick="document.getElementById('import-file').click()" style="background:#5856d6; margin:0;">导入数据</button>
                 </div>
             </div>
        </div>

        <div id="layer-stickers" class="layer">
            <div class="nav-bar">
                <div class="nav-icon" onclick="closeLayer('layer-stickers')"><i class="fas fa-chevron-left"></i></div>
                <div class="nav-title">表情包图库</div>
                <div class="nav-icon" onclick="openStickerMenu(event)"><i class="fas fa-ellipsis-h"></i></div>
            </div>
            <div class="add-menu" id="sticker-menu" style="top:44px; right:10px;">
                <div class="add-item" onclick="addStickerCategoryPopup()"><i class="fas fa-folder-plus"></i> 新建分类</div>
                <div class="add-item" onclick="addStickerPopup()" style="border:none;"><i class="fas fa-plus-square"></i> 添加表情</div>
            </div>
            <div class="sticker-layout">
                <div class="sticker-sidebar" id="sticker-categories"></div>
                <div class="sticker-content">
                    <div id="sticker-gallery-grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px;"></div>
                </div>
            </div>
        </div>

        <div id="layer-music" class="layer">
            <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-music')"><i class="fas fa-chevron-left"></i></div><div class="nav-title">一起听歌</div><div class="nav-icon" onclick="addMusicPopup()"><i class="fas fa-plus"></i></div></div>
            <div class="scroll-y" style="background:#fff; padding:10px;">
                <div id="music-list"></div>
            </div>
        </div>
        <div id="layer-persona-mgmt" class="layer">
            <div class="nav-bar"><div class="nav-icon" onclick="closeLayer('layer-persona-mgmt')"><i class="fas fa-chevron-left"></i></div><div class="nav-title">多重人设</div><div class="nav-icon" onclick="openPersonaModal()"><i class="fas fa-plus"></i></div></div>
            <div class="scroll-y" style="background:#f2f2f2; padding:15px;" id="persona-list"></div>
        </div>

        <div id="layer-beauty" class="layer">
            <div class="nav-bar"><div class="nav-icon" onclick="exitApp()"><i class="fas fa-chevron-left"></i></div><div class="nav-title">美化</div></div>
            <div class="scroll-y" style="background:#f2f2f2; padding:20px;">
                <button class="full-btn" onclick="uploadImg('desktop-bg')">修改主页背景 (本地上传)</button>
                <h3 style="margin-top:20px; color:#555;">修改图标</h3>
                <div id="beautify-grid" style="display:grid; grid-template-columns:repeat(4,1fr); gap:15px; margin-top:10px;"></div>
            </div>
        </div>
        <!-- MODALS -->
        <div id="modal-wb" class="modal-mask"><div class="modal-box">
            <h3>新建世界书</h3>
            <input id="new-wb-name" placeholder="名称" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <select id="new-wb-cate-sel" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
                <option value="">无分类</option>
            </select>
            <textarea id="new-wb-content" placeholder="内容" style="width:100%; height:150px; padding:10px; border:1px solid #ddd; border-radius:8px; resize:none;"></textarea>
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-wb').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveNewWorldBook()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <div id="modal-category" class="modal-mask"><div class="modal-box">
            <h3>创建世界书分类</h3>
            <input id="new-category-name" placeholder="分类名称" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-category').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveCategory()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <div id="modal-moment-generate" class="modal-mask"><div class="modal-box">
            <h3>生成朋友圈</h3>
            <p style="margin:10px 0; color:#666;">选择角色</p>
            <div id="moment-gen-contacts" style="max-height:200px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:10px;"></div>
            <input type="number" id="moment-gen-count" placeholder="生成篇数" min="1" max="10" value="3" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between;">
                <button onclick="document.getElementById('modal-moment-generate').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="generateMoments()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">生成</button>
            </div>
        </div></div>

        <div id="modal-diary-generate" class="modal-mask"><div class="modal-box">
            <h3>生成日记</h3>
            <p style="margin:10px 0; color:#666;">选择角色</p>
            <div id="diary-gen-contacts" style="max-height:200px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:10px;"></div>
            <input type="number" id="diary-gen-count" placeholder="生成篇数（每个角色）" min="1" max="5" value="1" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between;">
                <button onclick="document.getElementById('modal-diary-generate').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="generateDiaries()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">生成</button>
            </div>
        </div></div>

        <div id="modal-couple-date" class="modal-mask"><div class="modal-box">
            <h3>设置在一起的日期</h3>
            <input type="date" id="couple-start-date" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-couple-date').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveCoupleStartDate()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <div id="modal-api-preset" class="modal-mask"><div class="modal-box">
            <h3>添加API预设</h3>
            <input id="preset-name" placeholder="预设名称" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <input id="preset-url" placeholder="API Endpoint" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <input id="preset-key" type="password" placeholder="API Key" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input id="preset-model" placeholder="模型名称" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;">
                <button onclick="fetchModelsForPreset()" style="padding:0 10px; background:#576b95; color:#fff; border:none; border-radius:6px; font-size:12px;">拉取</button>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <button onclick="document.getElementById('modal-api-preset').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveAPIPreset()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <div id="modal-contact" class="modal-mask"><div class="modal-box">
            <h3>新建联系人</h3>
            <div style="text-align:center; margin:15px 0;"><div class="upload-box" style="width:80px; height:80px; border-radius:50%; margin:0 auto; background:#f2f2f2; display:flex; justify-content:center; align-items:center; cursor:pointer; position:relative; overflow:hidden;" onclick="uploadImg('new-contact-avatar')"><img id="new-contact-img" style="width:100%; height:100%; border-radius:50%; object-fit:cover; display:none; position:absolute; top:0; left:0;"><i class="fas fa-camera" style="font-size:24px; color:#ccc;"></i></div></div>
            <input id="new-contact-name" placeholder="名字" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <textarea id="new-contact-persona" placeholder="人设" style="width:100%; height:100px; padding:10px; border:1px solid #ddd; border-radius:8px; resize:none;"></textarea>
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-contact').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="createContact()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <div id="modal-persona" class="modal-mask"><div class="modal-box">
            <h3>新建人设</h3>
            <div style="text-align:center; margin:10px 0;"><div class="upload-box" style="width:60px; height:60px; border-radius:50%; margin:0 auto; background:#f2f2f2; display:flex; justify-content:center; align-items:center; cursor:pointer;" onclick="uploadImg('new-persona-avatar')"><img id="new-persona-img" style="width:100%; height:100%; border-radius:50%; object-fit:cover; display:none;"><i class="fas fa-camera" style="font-size:20px; color:#ccc;"></i></div></div>
            <input id="new-p-name" placeholder="名称" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <textarea id="new-p-desc" placeholder="描述" style="width:100%; height:100px; padding:10px; border:1px solid #ddd; border-radius:8px; resize:none;"></textarea>
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-persona').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveNewPersona()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <div id="modal-anniv" class="modal-mask"><div class="modal-box">
            <h3>添加纪念日</h3>
            <input id="ani-name" placeholder="名称" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <input id="ani-date" type="date" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <select id="ani-repeat" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"><option value="none">不重复</option><option value="year">每年</option></select>
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                <button onclick="document.getElementById('modal-anniv').style.display='none'" style="padding:10px 20px; border:none; background:#eee; border-radius:6px;">取消</button>
                <button onclick="saveAnniversary()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>

        <div id="modal-sticker" class="modal-mask"><div class="modal-box">
            <h3>添加表情包</h3>
            <div style="display:flex; gap:10px; margin:10px 0;">
                <button onclick="showStickerInput('local')" style="flex:1; padding:10px; border-radius:6px; border:1px solid #ddd; background:#fff;">本地上传</button>
                <button onclick="showStickerInput('url')" style="flex:1; padding:10px; border-radius:6px; border:1px solid #ddd; background:#fff;">URL链接</button>
            </div>
            <div id="sticker-url-area" style="display:none;">
                <input id="sticker-url-in" placeholder="输入图片链接" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:5px;">
                <button onclick="testLink('sticker-url-in')" style="padding:5px 10px; border:none; background:#576b95; color:#fff; border-radius:4px; font-size:12px;">测试链接</button>
            </div>
            <div id="sticker-local-area" style="display:none; text-align:center;">
                <button onclick="uploadImg('sticker-batch')" style="padding:10px20px; border:1px solid #ccc; background:#f9f9f9; border-radius:6px;">选择图片 (支持多选)</button>
            </div><div style="display:flex; justify-content:flex-end; margin-top:15px;">
                <button onclick="document.getElementById('modal-sticker').style.display='none'" style="padding:8px 20px; border:none; background:#eee; border-radius:6px; margin-right:10px;">取消</button>
                 <button onclick="confirmAddSticker()" style="padding:8px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">确定</button>
            </div>
        </div></div>

        <div id="modal-music" class="modal-mask"><div class="modal-box">
            <h3>添加音乐</h3>
            <div style="display:flex; gap:10px; margin:10px 0;">
                <button onclick="showMusicInput('local')" style="flex:1; padding:10px; border-radius:6px; border:1px solid #ddd; background:#fff;">本地上传</button>
                <button onclick="showMusicInput('url')" style="flex:1; padding:10px; border-radius:6px; border:1px solid #ddd; background:#fff;">URL链接</button>
            </div>
            <div id="music-url-area" style="display:none;">
                <input id="music-url-in" placeholder="输入MP3链接" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:5px;">
                <input id="music-name-in" placeholder="歌曲名称" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:5px;">
                <button onclick="testLink('music-url-in', 'audio')" style="padding:5px 10px; border:none; background:#576b95; color:#fff; border-radius:4px; font-size:12px;">测试链接</button>
            </div>
            <div id="music-local-area" style="display:none; text-align:center;">
                <button onclick="uploadImg('music-file')" style="padding:10px 20px; border:1px solid #ccc; background:#f9f9f9; border-radius:6px;">选择MP3文件</button>
            </div>
             <div style="display:flex; justify-content:flex-end; margin-top:15px;">
                 <button onclick="document.getElementById('modal-music').style.display='none'" style="padding:8px 20px; border:none; background:#eee; border-radius:6px; margin-right:10px;">取消</button>
                 <button onclick="confirmAddMusic()" style="padding:8px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">确定</button>
            </div>
        </div></div>

        <!-- Custom Input Modal -->
        <div id="modal-custom-input" class="modal-mask"><div class="modal-box">
            <h3 id="custom-input-title" style="margin-bottom:15px;">输入</h3>
            <input id="custom-input-val" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
            <input type="date" id="custom-input-date" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px; display:none;">
            <textarea id="custom-input-area" style="width:100%; height:80px; padding:10px; border:1px solid #ddd; border-radius:8px; display:none; resize:none;"></textarea>
            <div style="display:flex; justify-content:flex-end;">
                <button onclick="document.getElementById('modal-custom-input').style.display='none'" style="padding:8px 20px; border:none; background:#eee; border-radius:6px; margin-right:10px;">取消</button>
                <button onclick="confirmCustomInput()" style="padding:8px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">确定</button>
            </div>
        </div></div>
        <!-- Profile Edit Modal -->
        <div id="modal-profile-edit" class="modal-mask"><div class="modal-box">
             <h3>编辑个人信息</h3>
             <input id="p-edit-name" placeholder="名字" style="width:100%; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
             <input id="p-edit-wxid" placeholder="微信号" style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:8px;">
             <div style="display:flex; justify-content:flex-end;">
                 <button onclick="document.getElementById('modal-profile-edit').style.display='none'" style="padding:8px 20px; border:none; background:#eee; border-radius:6px; margin-right:10px;">取消</button>
                 <button onclick="saveProfileEdit()" style="padding:8px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px;">保存</button>
            </div>
        </div></div>
        
        <!-- Action Sheet Modal -->
        <div id="modal-moment-action" class="modal-mask"><div class="modal-box" style="text-align:center;">
             <div style="padding:15px; border-bottom:1px solid #eee;" onclick="openCustomInput('moment-text');document.getElementById('modal-moment-action').style.display='none'">文字</div>
             <div style="padding:15px; border-bottom:1px solid #eee;" onclick="uploadImg('post-moment');document.getElementById('modal-moment-action').style.display='none'">图片</div>
             <div style="padding:15px;" onclick="showMomentGenerateModal();document.getElementById('modal-moment-action').style.display='none'">AI生成</div>
        </div></div>

        <div id="modal-transfer-action" class="modal-mask"><div class="modal-box" style="text-align:center;">
             <h3 style="margin:15px 0;">转账操作</h3>
             <div style="padding:15px; border-bottom:1px solid #eee; color:#07c160; font-weight:bold;" onclick="handleTransferAction('receive')">确认收款</div>
             <div style="padding:15px; border-bottom:1px solid #eee; color:#fa5151;" onclick="handleTransferAction('return')">退回转账</div>
             <div style="padding:15px; color:#555;" onclick="document.getElementById('modal-transfer-action').style.display='none'">取消</div>
        </div></div>

        <input type="file" id="file-input" class="hidden">
        <div id="modal-picker" class="modal-mask"><div class="modal-box"><div class="modal-head" id="picker-title"></div><div style="max-height:300px; overflow-y:auto;" id="picker-list"></div><div style="padding:15px; text-align:center; border-top:1px solid #eee;" onclick="document.getElementById('modal-picker').style.display='none'">取消</div></div></div>
        <div id="modal-thought" class="modal-mask" onclick="this.style.display='none'"><div class="modal-box" style="padding:20px;" onclick="event.stopPropagation()"><h3 style="text-align:center; margin-bottom:10px;">心声</h3><div id="thought-text" style="line-height:1.6; color:#555;"></div></div></div>

        <!-- Generic Confirm Modal -->
        <div id="modal-confirm" class="modal-mask"><div class="modal-box" style="width: 80%; padding-top: 30px;">
            <h3 id="confirm-title" style="margin-bottom: 10px; text-align: center;">确认操作</h3>
            <p id="confirm-text" style="margin-bottom: 25px; text-align: center; color: #666; font-size: 14px;"></p>
            <div style="display:flex; justify-content:space-between; gap: 10px;">
                <button id="confirm-btn-cancel" style="flex: 1; padding:12px 20px; border:none; background:#eee; border-radius:8px; font-size: 16px;">取消</button>
                <button id="confirm-btn-ok" style="flex: 1; padding:12px 20px; border:none; background:var(--red); color:#fff; border-radius:8px; font-size: 16px;">确定</button>
            </div>
        </div></div>
        
        <!-- Contact Context Menu -->
        <div id="contact-menu" class="contact-menu">
            <div class="contact-menu-item" id="cm-pin" onclick="pinContact()">置顶聊天</div>
            <div class="contact-menu-item" onclick="deleteContact()" style="color:#fa5151;">删除好友</div>
        </div>
    </div>

    <script>
        // --- STORE ---
        const DB = {
            user: { name: "User", avatar: "", wxid: "wxid_888", balance: 1000, momentBg: '' },
            system: { url: "https://api.openai.com/v1", key: "", model: "gpt-3.5-turbo", temp: 0.7, minimaxKey: "" },
            contacts: [], chats: {}, moments: [], diaries: {}, offlineChat: [],
            personas: [{id:'p1', name:'默认', desc:'普通用户', avatar:''}],
            stickers: [], // Legacy, will be migrated
            stickerCategories: [{id:'default', name:'默认', stickers:[{url:'😀', type:'emoji'}]}],
            musics: [],
            couple: { partnerId: null, start: '', wishes: [], anniversaries: [], cycleDate:'', cycleLen:28 },
            perception: { 
                master: true,
                customDate: false, dateVal: '', 
                customTime: false, timeVal: '', 
                customCity: false, cityVal: '上海', 
                customWeather: false, weatherVal: '晴朗', tempVal: '26°C',
                customClimate: false, climateVal: '亚热带季风',
                festivals: [] 
            },
            phoneData: { contacts: [], memo: [], usage: [], search: [], chats: {} },
            appIcons: { wechat:'', worldbook:'', couple:'', perception:'', checkphone:'', beauty:'', settings:'' },
            desktopBg: '',
            bills: [],
            worldbooks: [],
            categories: [],
            apiPresets: []
        };
        let store = JSON.parse(localStorage.getItem('AIChatOS_v8')) || DB;
        const save = () => localStorage.setItem('AIChatOS_v8', JSON.stringify(store));
        
        let activeChatId = null;
        let tempImgTarget = null;
        let selectedMsgs = new Set();
        let activeStickerCateId = 'default';
        let isSelectMode = false;
        let customInputType = '';
        let coupleViewMode = 'list';
        let currentMusicIndex = 0;
        let selectedMomentContacts = new Set();
        let selectedDiaryContacts = new Set();
        let currentTransferMsgIdx = -1;
        let longPressTimer = null;
        let selectedContactId = null;
        let selectedMsgIdx = -1;
        let quoteContent = null;
        let isMultiSelect = false;
        let isLongPress = false;
        let selectedGroupContacts = new Set();
        // Diary globals
        let activeDiaryContactId = null;
        let activeDiaryIndex = -1;
        // Check phone global
        let activeCheckPhoneContactName = null;

        // --- API & AI ---
        async function aiGenerate(triggerType = 'manual') {
            if(!store.system.key) return toast("请先配置API Key");
            
            let apiUrl = store.system.url.trim();
            if(apiUrl.endsWith('/')) apiUrl = apiUrl.slice(0, -1);
            
            if(!activeChatId && triggerType === 'manual') return toast("无效的聊天");
            
            let c = activeChatId ? store.contacts.find(x=>x.id===activeChatId) : null;
            
            const originalTitle = document.getElementById('chat-title')?.innerText;
            if(triggerType === 'manual' && originalTitle) {
                document.getElementById('chat-title').innerText = "正在输入中...";
                showLoadingBubble();
            }

            try {
                let sysPrompt = "";
                let userP = store.personas[0];
                let msgs = [];

                if(triggerType === 'calibrate_weather') {
                     msgs.push({ role: "system", content: `You are a weather reporter. Generate realistic current weather for ${store.perception.city}. Reply ONLY in format: [WEATHER:Description|Temperature]. Example: [WEATHER:晴朗|26°C]` });
                     if(!store.perception.real) {
                         msgs.push({ role: "user", content: "Forecast please." });
                     } else {
                         // If "real" is on, we might want real data, but here we simulate via AI for simplicity as requested "via AI if connected"
                         // Actually the prompt asks for real net search if connected, but we only have LLM. 
                         // We will simulate "smart guess" based on city/date.
                         msgs.push({ role: "user", content: `It is ${new Date().toDateString()} in ${store.perception.city}. Guess the weather.` });
                     }
                } else if (triggerType.startsWith('wish_reply')) {
                     const wishText = triggerType.split('::')[1];
                     const partner = store.contacts.find(x=>x.id===store.couple.partnerId);
                     if(!partner) return; 
                     msgs.push({ role: "system", content: `You are ${partner.name}. Your partner added a wish: "${wishText}". Reply lovingly. Format: [WISH_REPLY:your reply]` });
                } else if(triggerType.startsWith('generate_moment')) {
                    const contactId = triggerType.split('::')[1];
                    c = store.contacts.find(x=>x.id===contactId);
                    if(!c) throw new Error("找不到联系人(Moment): " + contactId);
                    msgs.push({ role: "system", content: `You are ${c.name}. Generate a moment post about your daily life. Use Chinese. Format: [MOMENT:text|image_description]. Example: [MOMENT:今天天气真好~|sunny day]` });
                    msgs.push({ role: "user", content: "Generate a new moment." });
                } else if(triggerType.startsWith('reply_moment_comment')) {
                    const parts = triggerType.split('::'); // reply_moment_comment::contactId::momentId::commentText::commentAuthor
                    c = store.contacts.find(x=>x.id===parts[1]); // The one who is replying (moment author)
                    if(!c) return;
                    msgs.push({ role: "system", content: `You are ${c.name}. ${parts[4]} commented on your moment: "${parts[3]}". Reply to them. Keep it short. Format: [COMMENT_REPLY:text]` });
                    msgs.push({ role: "user", content: "..." });
                } else if(triggerType.startsWith('comment_ai_moment')) {
                    const parts = triggerType.split('::'); // comment_ai_moment::commenterId::momentId::momentText::momentAuthor
                    c = store.contacts.find(x=>x.id===parts[1]); // The one who is commenting
                    if(!c) return;
                    msgs.push({ role: "system", content: `You are ${c.name}. Your AI friend ${parts[4]} posted a moment: "${parts[3]}". Comment on it. Keep it short. Format: [COMMENT_REPLY:text]` });
                    msgs.push({ role: "user", content: "..." });
                } else if(triggerType.startsWith('comment_user_moment')) {
                    const parts = triggerType.split('::');
                    c = store.contacts.find(x=>x.id===parts[1]);
                    if(!c) return;
                    msgs.push({ role: "system", content: `You are ${c.name}. Your friend User posted a moment: "${parts[3]}". Comment on it. Keep it short. Format: [MOMENT_COMMENT:text]` });
                } else if(triggerType.startsWith('generate_diary')) {
                    const contactId = triggerType.split('::')[1];
                    c = store.contacts.find(x=>x.id===contactId);
                    if(!c) throw new Error("找不到联系人(Diary): " + contactId);
                    
                    // Improved Diary Prompt
                    const chatHist = (store.chats[contactId] || []).slice(-10).map(m => (m.sender==='me'?'User':c.name) + ': ' + m.content).join('\n');
                    const momentsHist = store.moments.filter(m=>m.name===c.name).slice(0,3).map(m=>m.content).join('; ');
                    
                    msgs.push({ role: "system", content: `You are ${c.name}. Write a diary entry for today. 
                    Persona: ${c.persona}
                    Recent Chat Context: 
                    ${chatHist}
                    Recent Moments:
                    ${momentsHist}
                    
                    Write a personal, emotional diary entry reflecting on these events or your day.
                    Use Chinese. 
                    Format: [DIARY:Title|Content]` });
                    msgs.push({ role: "user", content: "Write today's diary." });
                } else {
                     if (!c) return;
                 userP = store.personas.find(p=>p.id===c.settings?.userPersona) || store.personas[0];
                 const wb = (store.worldbooks||[]).find(w=>w.id===c.settings?.wb);
                 const recentMoments = store.moments.slice(0,5).map(m=>`${m.name}: ${m.content}`).join('; ');
                 
                 // --- Perception Context Construction ---
                 let percContext = "Perception: OFF";
                 let enablePerc = c.settings?.enablePerception !== false; // Default true
                 if (enablePerc) {
                     const p = store.perception;
                     // Time
                     let date = p.customDate ? p.dateVal : new Date().toLocaleDateString();
                     let time = p.customTime ? p.timeVal : new Date().toLocaleTimeString();
                     
                     // Global Custom Weather override
                     let globalWeather = (p.customWeather && p.weatherVal) ? p.weatherVal : null;
                     
                     // Locations
                     // User
                     let userVC = c.settings?.userVirtualCity || (p.customCity ? p.cityVal : p.city);
                     let userRC = c.settings?.userRealCity || (p.customCity ? p.realCityVal : p.city);
                     if(!userVC) userVC = "未知";
                     if(!userRC) userRC = userVC;

                     // AI
                     let aiVC = c.settings?.aiVirtualCity; // If empty, implies same as user
                     let aiRC = c.settings?.aiRealCity;
                     let isSameLoc = !aiVC;
                     if(isSameLoc) { aiVC = userVC; aiRC = userRC; }
                     else { if(!aiRC) aiRC = aiVC; }

                     percContext = `
                        [Time: ${date} ${time}]
                        [User Loc: Virtual<${userVC}> Real<${userRC}>]
                        [AI Loc: Virtual<${aiVC}> Real<${aiRC}>]
                        [Relation: ${isSameLoc ? 'Together' : 'Long Distance'}]
                        [Global Weather Override: ${globalWeather || 'None'}]
                        [Climate: ${p.climate || 'Default'}]
                     `;
                 }

                 let availableStickers = [];
                 if(c.settings?.mountedCateIds && c.settings.mountedCateIds.length > 0) {
                     c.settings.mountedCateIds.forEach(cid => {
                         const cate = store.stickerCategories.find(sc=>sc.id===cid);
                         if(cate && cate.stickers) availableStickers = availableStickers.concat(cate.stickers.map(s=>s.url));
                     });
                 } else if (c.settings?.mountedStickers) {
                     availableStickers = c.settings.mountedStickers.split(',').filter(x=>x);
                 }
                 const mountedStickersStr = availableStickers.join(',');
                 
                 sysPrompt = `You are ${c.name}. Persona: ${c.persona}. 
                    User is ${userP.name} (${userP.desc}). 
                    World Context: ${wb ? wb.content : 'None'}.
                    Recent Moments: ${recentMoments}.
                    
                    ${percContext}
                    
                    Instructions: 
                    1. Use the Perception Context to ground your reply. 
                    2. If "Global Weather Override" is set, use it. Otherwise, infer the weather based on the "Real" location and current Season/Time. 
                    3. If you and User are "Together", assume shared environment. If "Long Distance", you can discuss weather differences.
                    4. Trigger: ${triggerType}. 

                    Reply in Chinese, 1-2 sentences.
                    
                    Formats:
                    - Text: Just plain text
                    - Sticker: [STICKER:url] (Select from: ${mountedStickersStr || 'None'})
                    - Voice: [VOICE:text] (Use sparingly)
                    - Image: [IMG:description]
                    - Location: [LOC:address]
                    - Transfer: [TRANS:amount|note]
                    - Heartbeat: ALWAYS END WITH [HEARTBEAT:Location|Outfit|Status|Thought].`; 
                 msgs.push({ role: "system", content: sysPrompt });
                 const history = (store.chats[activeChatId]||[]).slice(-10);
                 history.forEach(m => {
                    let content = m.content;
                    if(m.type==='image') {
                        if (store.system.model.includes('4o') || store.system.model.includes('vision') || store.system.model.includes('claude')) {
                             content = [
                                { type: "text", text: "User sent an image." },
                                { type: "image_url", image_url: { url: m.content } }
                             ];
                        } else {
                             content = "[User sent an image: " + m.content + "]";
                        }
                    }
                    else if(m.type==='voice') content = `[Voice: ${m.textVal||'...'}]`;
                    else if(m.type==='transfer') content = `[Transfer: ${m.content}]`;
                    else if(m.type==='transfer_receipt') content = `[Transfer System: ${m.status==='received' ? 'Transfer accepted' : 'Transfer returned'}]`;
                    
                    if(Array.isArray(content)) {
                        msgs.push({ role: m.sender==='me'?'user':'assistant', content: content });
                    } else {
                        msgs.push({ role: m.sender==='me'?'user':'assistant', content: String(content) });
                    }
                 });

                 const lastMsg = (store.chats[activeChatId]||[]).slice(-1)[0];
                 if(lastMsg && lastMsg.sender === 'me' && lastMsg.type === 'transfer' && !lastMsg.status) {
                     msgs.push({ role: "system", content: "User sent you money. Decide to receive or return. Return Format: [TRANS_OP:RECEIVE] or [TRANS_OP:RETURN]" });
                 }
            }
            
                const res = await fetch(apiUrl + '/chat/completions', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer '+store.system.key},
                    body: JSON.stringify({
                        model: store.system.model, 
                        messages: msgs, 
                        temperature: parseFloat(store.system.temp || 0.7) 
                    })
                });
                
                if(!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                if(triggerType === 'manual' && originalTitle) {
                    document.getElementById('chat-title').innerText = originalTitle;
                    removeLoadingBubble();
                }

                const reply = data.choices[0].message.content;
                console.log('API Response:', reply);
                
                if(triggerType === 'calibrate_weather') {
                    const match = reply.match(/\[WEATHER:([\s\S]*?)\|([\s\S]*?)\]/);
                    if(match) {
                        store.perception.weather = match[1];
                        store.perception.temp = match[2];
                        save(); renderPerception(); toast("校准成功");
                    } else { toast("校准失败"); }
                    return;
                }

                if(triggerType.startsWith('wish_reply')) {const match = reply.match(/\[WISH_REPLY:([\s\S]*?)\]/);
                     if(match && store.couple.wishes.length > 0) {
                         store.couple.wishes[store.couple.wishes.length-1].reply = match[1];
                         save(); renderCouple();}return;
                }

                if(triggerType.startsWith('reply_moment_comment') || triggerType.startsWith('comment_ai_moment') || reply.includes('[COMMENT_REPLY:')) {
                    const match = reply.match(/\[COMMENT_REPLY:([\s\S]*?)\]/);
                    const text = match ? match[1].trim() : reply.replace(/\[COMMENT_REPLY:|\]/g, '').trim();
                    const parts = triggerType.split('::');
                    const mId = parseInt(parts[2]);
                    const m = store.moments.find(x=>x.id===mId);
                    if(m) {
                        if(!m.comments) m.comments=[];
                        
                        let replyToName = store.user.name; // Default reply to user
                        if(triggerType.startsWith('comment_ai_moment')) {
                             replyToName = parts[4]; // Reply to the AI author
                        } else if (triggerType.startsWith('reply_moment_comment')) {
                             replyToName = parts[4]; // Reply to the original commenter
                        }

                        m.comments.push({name:c.name, text:text, replyTo: replyToName });
                        save(); 
                        if(document.getElementById('tab-moments').classList.contains('active')) {
                           renderMoments();
                        }
                    }
                    return;
                }

                if(triggerType.startsWith('comment_user_moment') || reply.includes('[MOMENT_COMMENT:')) {
                    const match = reply.match(/\[MOMENT_COMMENT:([\s\S]*?)\]/);
                    const text = match ? match[1].trim() : reply.replace(/\[MOMENT_COMMENT:|\]/g, '').trim();
                    const parts = triggerType.split('::');
                    const mId = parseInt(parts[2]);
                    const m = store.moments.find(x=>x.id===mId);
                    if(m) {
                        if(!m.comments) m.comments=[];
                        m.comments.push({name:c.name, text:text});
                        save(); renderMoments();
                    }
                    return;
                }
                
                if(triggerType.startsWith('generate_moment') || reply.includes('[MOMENT:')) {
                    let mText = '分享生活', mImgDesc = '';
                    let cleanReply = reply.replace(/\[HEARTBEAT:[\s\S]*?\]/g, '');
                    
                    const match = cleanReply.match(/\[MOMENT:([\s\S]*?)(?:\|([\s\S]*?))?\]/);
                    if(match) {
                         mText = match[1].trim();
                         mImgDesc = match[2] ? match[2].trim() : '';
                    } else {
                        mText = cleanReply.replace(/\[MOMENT:|\]/g, '').trim();
                        if(mText.includes('|')) {
                             const p = mText.split('|');
                             mText = p[0];
                             mImgDesc = p.slice(1).join(' ');
                        }
                    }
                    mText = mText.replace(/^["']|["']$/g, '');
                    const mImg = (mImgDesc && mImgDesc.toLowerCase()!=='null') ? textToImage(mImgDesc, '#87CEEB', '#fff') : null;
                    const newMomentId = Date.now();
                    const contactId = triggerType.split('::')[1];
                    
                    store.moments.unshift({ id: newMomentId, name: c.name, avatar: c.avatar, content: mText, img: mImg, time: newMomentId, likes: [], comments: [] });
                    save(); 
                    if(document.getElementById('tab-moments').classList.contains('active')) {
                        renderMoments();
                    }

                    // AI to AI interaction logic
                    if (aiMomentInteractionEnabled && c.name !== store.user.name) {
                        const otherAIs = store.contacts.filter(con => con.id !== contactId && !con.isGroup);
                        if (otherAIs.length > 0) {
                            const commenter = otherAIs[Math.floor(Math.random() * otherAIs.length)];
                            setTimeout(() => {
                                // comment_ai_moment::commenterId::momentId::momentText::momentAuthor
                                aiGenerate(`comment_ai_moment::${commenter.id}::${newMomentId}::${mText.substring(0, 25)}::${c.name}`);
                            }, 2000 + Math.random() * 3000); // Random delay
                        }
                    }
                    return; 
                }

                if(triggerType.startsWith('generate_diary') || reply.includes('[DIARY:')) {
                    let title = '日记', content = '';
                    const match = reply.match(/\[DIARY:([\s\S]*?)\]/);
                    if(match) {
                        let inner = match[1];
                        if(inner.includes('|')) { const p = inner.split('|'); title = p[0].trim(); content = p.slice(1).join('|').trim(); }
                        else { content = inner.trim(); }
                    } else {
                        // Fallback parsing
                        const clean = reply.replace(/\[DIARY:|\]/g, '').trim();
                        const lines = clean.split('\n');
                        if(lines.length > 0) title = lines[0].substring(0, 15);
                        content = clean;
                    }

                    if(!content) content = "今天发生了什么...";

                    if(!store.diaries[c.id]) store.diaries[c.id] = [];
                    store.diaries[c.id].push({title: title, content: content, date: new Date().toLocaleString(), time: Date.now()});
                    save();
                    // Force refresh if detailed view is open
                    if(document.getElementById('layer-diary-detail').classList.contains('show') && activeDiaryContactId === c.id) {
                        openDiaryDetail(c.id);
                    }
                    return;
                }
                
                if(reply.includes('[TRANS_OP:')) {
                    const lastMsgIdx = store.chats[activeChatId].length - 1;
                    const lastMsg = store.chats[activeChatId][lastMsgIdx];
                    if(lastMsg && lastMsg.sender === 'me' && lastMsg.type === 'transfer' && !lastMsg.status) {
                 if(reply.includes('RECEIVE')) {
                            lastMsg.status = 'received';
                        } else {
                            lastMsg.status = 'returned';
                            store.user.balance += parseFloat(lastMsg.content.split('|')[0]);
                            store.bills.push({type:'in', amt:parseFloat(lastMsg.content.split('|')[0]), desc:'转账退回', time:Date.now()});
                        }
                        save();
                        renderHistory();
                    }
                }

                let heart = "";
                const hMatch = reply.match(/\[HEARTBEAT:([\s\S]*?)\]/);
                if(hMatch) { heart = hMatch[1]; }
                
                let type = 'text';
                let content = reply.replace(/\[HEARTBEAT:[\s\S]*?\]/g, '').replace(/\[THOUGHT:[\s\S]*?\]/g, '').replace(/\[TRANS_OP:[\s\S]*?\]/g, '').trim();
                
                if(content.includes('[VOICE:')) {
                    const m = content.match(/\[VOICE:(.*?)\]/);
                    type='voice'; 
                    content = Math.floor(Math.random()*5+2)+"'";if(m) {
                        if(!store.chats[activeChatId]) store.chats[activeChatId] = [];
                        const msgObj = { sender: 'ai', type: 'voice', content, textVal: m[1], heart, time: Date.now() };
                        store.chats[activeChatId].push(msgObj);
                        if(c) c.lastMsgTime = Date.now();
                        save(); 
                        appendMsgRow(msgObj, store.chats[activeChatId].length-1);
                        return;
                    }
                }
                else if(content.includes('[STICKER:')) {
                    const m = content.match(/\[STICKER:(.*?)\]/);
                    type='image';
                    content = m ? m[1] : 'https://via.placeholder.com/150';
                }
                else if(content.includes('[IMG:')) { 
                    const m = content.match(/\[IMG:(.*?)\]/);
                    type='image'; 
                    content = m ? textToImage(m[1], '#FFB6C1', '#000000') : textToImage('Image');
                }
                else if(content.includes('[LOC:')) { 
                    const m = content.match(/\[LOC:(.*?)\]/);
                    type='location'; 
                    content = m ? m[1] : '未知位置';
                }
                else if(content.includes('[TRANS:')) { 
                    const m = content.match(/\[TRANS:(.*?)\]/);
                    type='transfer'; 
                    content = m ? m[1] : '0|转账';
                }
                
                if(content) {
                    if(!store.chats[activeChatId]) store.chats[activeChatId] = [];
                    const msgObj = { sender: 'ai', type, content, heart, time: Date.now() };
                    store.chats[activeChatId].push(msgObj);
                    if(c) c.lastMsgTime = Date.now();
                    save(); 
                    appendMsgRow(msgObj, store.chats[activeChatId].length-1);
                }

            } catch(e) {
                console.error('API Error:', e);
                if(triggerType==='manual' && originalTitle) {
                    document.getElementById('chat-title').innerText = originalTitle;
                    removeLoadingBubble();
                }
                toast("API错误: "+e.message);
            }
        }

        function showLoadingBubble() {
            const history = document.getElementById('chat-history');
            if(!history) return;
            const row = document.createElement('div');
            row.id = 'temp-loading-bubble';
            row.className = 'msg-row';
            const c = store.contacts.find(x=>x.id===activeChatId);
            const avatar = c?.avatar || 'https://via.placeholder.com/50';
            row.innerHTML = `<img src="${avatar}" class="avatar"><div class="bubble loading">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
            history.appendChild(row);
            history.scrollTop = history.scrollHeight;
        }

        function removeLoadingBubble() {
            const el = document.getElementById('temp-loading-bubble');
            if(el) el.remove();
        }

        async function playTTS(text) {
            toast("正在合成语音...");
            try {
                const audioBlob = await API.textToSpeech(text);
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = document.getElementById('tts-audio');
                audio.src = audioUrl;
                audio.play();
            } catch (e) {
                console.error('TTS Error:', e);
                // Toast is already handled by API module
            }
        }

        function playVoiceMessage(idx) {
            const msg = store.chats[activeChatId][idx];
            if (!msg) return;

            // Always allow converting to text for any voice message on click.
            toggleVoiceText(idx);
            
            // With MiniMax, also play audio. This is for AI voice message.
            if (store.system.minimaxKey && msg.sender === 'ai' && msg.textVal) {
                playTTS(msg.textVal);
            }
        }


        async function aiRetry() {
             if(store.chats[activeChatId] && store.chats[activeChatId].length > 0) {
                 if(store.chats[activeChatId].slice(-1)[0].sender === 'ai') {
                     store.chats[activeChatId].pop();
                     save(); renderHistory();
                     aiGenerate();
                 }
             }
        }
        
        function calibrateWeather() {
             aiGenerate('calibrate_weather');
        }

        // --- MOMENT & DIARY GENERATION ---
        function showMomentGenerateModal() {
            const modal = document.getElementById('modal-moment-generate');
            const contactList = document.getElementById('moment-gen-contacts');
            selectedMomentContacts.clear();
            
            contactList.innerHTML = store.contacts.map(c => `
                <label style="display:flex; align-items:center; padding:8px; cursor:pointer;">
                    <input type="checkbox" onchange="toggleMomentContact('${c.id}')" style="margin-right:10px;">
                    <img src="${c.avatar}" class="avatar" style="width:32px; height:32px; margin-right:10px;">
                    <span>${c.name}</span>
                </label>
            `).join('');
            
            modal.style.display = 'flex';
        }

        function toggleMomentContact(id) {
            if(event.target.checked) selectedMomentContacts.add(id);
            else selectedMomentContacts.delete(id);
        }

        async function generateMoments() {
            const count = parseInt(document.getElementById('moment-gen-count').value) || 1;
            if(selectedMomentContacts.size === 0) return toast("请选择角色");
            
            document.getElementById('modal-moment-generate').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            for(const contactId of selectedMomentContacts) {
                for(let i=0; i<count; i++) {
                    await aiGenerate('generate_moment::'+contactId);
                    await new Promise(r => setTimeout(r, 500));
                }
            }
            
            document.getElementById('loading').style.display = 'none';
            renderMoments();
            toast("生成完成");
        }

        function showDiaryGenerateModal() {
            const modal = document.getElementById('modal-diary-generate');
            const contactList = document.getElementById('diary-gen-contacts');
            selectedDiaryContacts.clear();
            
            contactList.innerHTML = store.contacts.map(c => `
                <label style="display:flex; align-items:center; padding:8px; cursor:pointer;">
                    <input type="checkbox" onchange="toggleDiaryContact('${c.id}')" style="margin-right:10px;">
                    <img src="${c.avatar}" class="avatar" style="width:32px; height:32px; margin-right:10px;">
                    <span>${c.name}</span>
                </label>
            `).join('');
            
            modal.style.display = 'flex';
        }

        function toggleDiaryContact(id) {
            if(event.target.checked) selectedDiaryContacts.add(id);
            else selectedDiaryContacts.delete(id);
        }

        async function generateDiaries() {
            const count = parseInt(document.getElementById('diary-gen-count').value) || 1;
            if(selectedDiaryContacts.size === 0) return toast("请选择角色");
            
            document.getElementById('modal-diary-generate').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            for(const contactId of selectedDiaryContacts) {
                for(let i=0; i<count; i++) {
                    await aiGenerate('generate_diary::'+contactId);
                    await new Promise(r => setTimeout(r, 500));
                }
            }
            
            document.getElementById('loading').style.display = 'none';
            renderDiaryGrid();
            toast("日记生成完成");
        }

        // --- DIARY FUNCTIONS ---
        function openDiary() {
            document.getElementById('layer-diary').classList.add('show');
            renderDiaryGrid();
        }

        function renderDiaryGrid() {
            const grid = document.getElementById('diary-grid');
            const contacts = store.contacts.filter(c => store.diaries[c.id] && store.diaries[c.id].length > 0);
            
            grid.innerHTML = contacts.length === 0 ? '<div style="text-align:center; color:#999; margin-top:100px;">暂无日记<br>点击右上角生成</div>' : '';
            
            contacts.forEach(c => {
                grid.innerHTML += `
                    <div class="list-item" onclick="openDiaryDetail('${c.id}')" style="border-radius:12px; margin-bottom:10px; background:linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                        <img src="${c.avatar}" class="avatar">
                        <div class="list-content">
                            <div class="list-title" style="color:#fff;">${c.name}的日记</div>
                            <div class="list-sub" style="color:rgba(255,255,255,0.8);">${store.diaries[c.id].length}篇</div>
                        </div>
                        <i class="fas fa-chevron-right" style="color:#fff;"></i>
                    </div>
                `;
            });
        }

        function openDiaryDetail(contactId) {
            activeDiaryContactId = contactId;
            const c = store.contacts.find(x=>x.id===contactId);
            document.getElementById('diary-detail-name').innerText = c.name + ' 的日记';
            document.getElementById('layer-diary-detail').classList.add('show');
            
            const content = document.getElementById('diary-detail-content');
            const diaries = store.diaries[contactId] || [];
            
            if(diaries.length === 0) {
                content.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">暂无日记</div>';
                return;
            }

            // Descending order
            const sorted = [...diaries].reverse();
            content.innerHTML = sorted.map((d,i) => {
                // Since we reversed, original index is length - 1 - i
                const originalIndex = diaries.length - 1 - i;
                return `
                <div class="list-item" onclick="readDiary('${contactId}', ${originalIndex})" style="border-radius:8px; margin-bottom:8px;">
                    <div class="list-content">
                        <div class="list-title">${d.title}</div>
                        <div class="list-sub">${d.date}</div>
                    </div>
                    <i class="fas fa-angle-right" style="color:#ddd;"></i>
                </div>
            `}).join('');
        }

        function readDiary(contactId, index) {
            activeDiaryContactId = contactId;
            activeDiaryIndex = index;
            const d = store.diaries[contactId][index];
            document.getElementById('diary-read-body').innerHTML = `
                <h2 style="margin-bottom:10px;">${d.title}</h2>
                <div style="color:#999; font-size:13px; margin-bottom:20px;">${d.date}</div>
                <div style="line-height:1.8; font-size:16px; white-space:pre-wrap;">${d.content}</div>
            `;
            document.getElementById('layer-diary-read').classList.add('show');
        }

        function editCurrentDiary() {
            const d = store.diaries[activeDiaryContactId][activeDiaryIndex];
            const newTitle = prompt("修改标题:", d.title);
            if(newTitle) {
                const newContent = prompt("修改内容 (支持换行):", d.content); 
                if(newContent) {
                    d.title = newTitle;
                    d.content = newContent;
                    save();
                    readDiary(activeDiaryContactId, activeDiaryIndex);
                    openDiaryDetail(activeDiaryContactId); 
                    toast("修改成功");
                }
            }
            document.getElementById('diary-read-menu').style.display = 'none';
        }

        function deleteCurrentDiary() {
            if(confirm("确定删除这篇日记?")) {
                store.diaries[activeDiaryContactId].splice(activeDiaryIndex, 1);
                save();
                document.getElementById('layer-diary-read').classList.remove('show');
                openDiaryDetail(activeDiaryContactId);
                toast("删除成功");
            }
            document.getElementById('diary-read-menu').style.display = 'none';
        }

        // --- PROACTIVE LOOP ---
        setInterval(() => {
            const now = Date.now();
            store.contacts.forEach(c => {
                if(!c.settings) return;
                if(c.settings.autoMsg && c.settings.autoMsgInterval) {
                     const last = c.lastMsgTime || 0;
                     if(now - last > c.settings.autoMsgInterval * 60000) {
                         activeChatId = c.id;
                         aiGenerate('auto_msg');
                         c.lastMsgTime = now;
                     }
                }if(c.settings.autoMoment && Math.random() < 0.01) {
                    aiGenerate('generate_moment::'+c.id);
                }if(c.settings.autoDiary) {
                    const hour = new Date().getHours();
                    const targetHour = parseInt((c.settings.diaryTime||'22:00').split(':')[0]);
                    if(hour === targetHour && (!c.lastDiaryTime || now - c.lastDiaryTime > 3600000)) {
                        aiGenerate('generate_diary::'+c.id);
                        c.lastDiaryTime = now;
                    }
                }
            });
        }, 10000);

        // --- COMMON UI ---
        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }

        function showConfirm(title, text, onOk) {
            const modal = document.getElementById('modal-confirm');
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-text').innerText = text;
            modal.style.display = 'flex';

            const okBtn = document.getElementById('confirm-btn-ok');
            const cancelBtn = document.getElementById('confirm-btn-cancel');

            // Remove old listeners before adding new ones to prevent multiple executions
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            const okHandler = () => {
                onOk();
                modal.style.display = 'none';
            };

            const cancelHandler = () => {
                modal.style.display = 'none';
            };
            
            newOkBtn.addEventListener('click', okHandler);
            newCancelBtn.addEventListener('click', cancelHandler);
        }
        function togglePopup(id) {
            const el = document.getElementById(id);
            el.style.display = el.style.display==='flex' ? 'none' : 'flex';
        }
        function openApp(id) {
            document.getElementById('layer-desktop').classList.remove('active');
            const el = document.getElementById(`layer-${id}`);
            if(el.classList.contains('page')) el.classList.add('active'); else el.classList.add('show');
            
            if(id==='wechat') { 
                const contacts = document.getElementById('tab-contacts');
                const moments = document.getElementById('tab-moments');
                const me = document.getElementById('tab-me');
                
                contacts.classList.add('active');
                moments.classList.remove('active');
                me.classList.remove('active');

                const tabs = document.querySelectorAll('.nav-tab');
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
                tabs[2].classList.remove('active');

                renderContacts();
                renderMoments(); }
            if(id==='worldbook') renderWorldBooks();
            if(id==='couple') { coupleViewMode='list'; renderCouple(); }
            if(id==='perception') renderPerception();
            if(id==='stickers') renderStickerGallery();
            if(id==='music') renderMusicList();
            if(id==='beauty') renderBeautify();
            if(id==='settings') {
                document.getElementById('sys-url').value = store.system.url;
                document.getElementById('sys-key').value = store.system.key;
                document.getElementById('sys-minimax-key').value = store.system.minimaxKey || '';
                const sel = document.getElementById('sys-model');
                let found = false;
                for(let i=0; i<sel.options.length; i++) { if(sel.options[i].value === store.system.model) found = true; }
                if(!found) {const opt = document.createElement('option');
                     opt.value = store.system.model; opt.innerText = store.system.model;
                     sel.appendChild(opt);
                }
                sel.value = store.system.model;
                renderAPIPresets();
            }
        }
        function exitApp() {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.layer').forEach(e => e.classList.remove('show'));
            document.getElementById('layer-desktop').classList.add('active');
        }
        function closeLayer(id) {document.getElementById(id).classList.remove('show'); }
        function switchTab(idx, el) {
            document.querySelectorAll('#layer-wechat .page').forEach(e => e.classList.remove('active'));
            const tabs = ['tab-contacts', 'tab-moments', 'tab-me'];document.getElementById(tabs[idx]).classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            if(el) el.classList.add('active');
            if(idx === 0) renderContacts();
            if(idx === 1) renderMoments();
        }
        function toggleAddMenu(e, id) { 
            e.stopPropagation(); 
            const el = document.getElementById(id==='couple'?'couple-add-menu':'wx-add-menu'); 
            // Close other menus first
            document.querySelectorAll('.add-menu').forEach(m => { if(m.id !== el.id) m.style.display = 'none'; });
            el.style.display = el.style.display==='flex'?'none':'flex'; 
        }
        function toggleWBMenu(e) {
            e.stopPropagation();
            const el = document.getElementById('wb-add-menu');
            document.querySelectorAll('.add-menu').forEach(m => { if(m.id !== el.id) m.style.display = 'none'; });
            el.style.display = el.style.display==='flex'?'none':'flex';
        }
        
        // Optimized Global Click Handler
        document.addEventListener('click', function(e) {
            // Close Popups/Menus if clicking outside
            if (!e.target.closest('.nav-icon') && !e.target.closest('.fa-smile') && !e.target.closest('.pop-menu') && !e.target.closest('.add-menu') && !e.target.closest('.sticker-panel') && !e.target.closest('.contact-menu')) {
                document.querySelectorAll('.pop-menu, .add-menu, .sticker-panel, .contact-menu').forEach(el => {
                    el.style.display = 'none';
                });
            }
            // Specific handling for msg-menu to prevent ghost clicks
            const mm = document.getElementById('msg-menu');
            if(mm && mm.style.display!=='none' && !mm.contains(e.target)) {
                mm.style.display='none';
            }
        }, true); // Use capture phase to ensure it catches clicks

        // --- DESKTOP RENDER ---
        function renderDesktop() {
            const apps = [
                {id:'wechat', name:'微信', icon:'f075', col:'#07c160'},
                {id:'worldbook', name:'世界书', icon:'f02d', col:'#5856d6'},
                {id:'couple', name:'情侣空间', icon:'f004', col:'#ff758c'},
                {id:'perception', name:'感知', icon:'f5eb', col:'#4facfe'},
                {id:'checkphone', name:'查手机', icon:'f3cd', col:'#333'},
                {id:'beauty', name:'美化', icon:'f0d0', col:'#ff9a9e'},
                {id:'settings', name:'设置', icon:'f013', col:'#8e8e93'}
            ];
            const grid = document.getElementById('desktop-grid');
            grid.innerHTML = '';
            apps.forEach(app => {
                const bg = store.appIcons[app.id] ? `background-image:url(${store.appIcons[app.id]})` : `background:${app.col}`;
                const inner = store.appIcons[app.id] ? '' : `<i class="fas fa-${app.icon}"></i>`;
                grid.innerHTML += `<div class="app-item" onclick="openApp('${app.id}')"><div class="app-icon" style="${bg}">${inner}</div><span class="app-name">${app.name}</span></div>`;
            });
            if(store.desktopBg) document.getElementById('desktop').style.backgroundImage = `url(${store.desktopBg})`;
        }
        renderDesktop();

        // --- CHAT LOGIC ---
        function openChat(cid) {
            activeChatId = cid;
            const c = store.contacts.find(x=>x.id===cid);
            document.getElementById('chat-title').innerText = c.name;
            document.getElementById('layer-chat').classList.add('show');
            // Fix: Use c.settings.bg if available, fallback to c.bg
            const bg = (c.settings && c.settings.bg) ? c.settings.bg : (c.bg || '');
            document.getElementById('chat-history').style.backgroundImage = bg ? `url(${bg})` : 'none';
            renderHistory();
        }
        
        function renderHistory() {
            const history = document.getElementById('chat-history');
            history.innerHTML = '';
            const msgs = store.chats[activeChatId] || [];
            msgs.forEach((m, idx) => appendMsgRow(m, idx));
        }

        function appendMsgRow(m, idx) {
            // This function is performance-critical. Using `createElement` and `appendChild`
            // is significantly faster than `innerHTML += ...` for list rendering.
            const history = document.getElementById('chat-history');
            if (!history) return;

            const currentChat = store.contacts.find(c => c.id === activeChatId);
            const isGroup = currentChat?.isGroup;
            const isMe = m.sender === 'me';

            const row = document.createElement('div');
            row.className = `msg-row ${isMe ? 'me' : ''}`;

            // 1. Create Avatar
            let avatarSrc;
            let senderName = '';
            if (isMe) {
                avatarSrc = store.user.avatar || 'https://via.placeholder.com/50';
            } else {
                const senderContact = isGroup ? store.contacts.find(c => c.id === m.sender) : currentChat;
                avatarSrc = senderContact?.avatar || 'https://via.placeholder.com/50';
                senderName = senderContact?.name || 'Unknown';
            }
            const avatarImg = document.createElement('img');
            avatarImg.src = avatarSrc;
            avatarImg.className = 'avatar';

            // 2. Create Bubble Container (for name + bubble)
            const bubbleContainer = document.createElement('div');
            bubbleContainer.style.cssText = `display: flex; flex-direction: column; max-width: 250px; align-items: ${isMe ? 'flex-end' : 'flex-start'};`;

            // 3. Add sender name label for group chats
            if (isGroup && !isMe) {
                const nameLabel = document.createElement('div');
                nameLabel.innerText = senderName;
                nameLabel.style.cssText = `font-size: 12px; color: #888; margin-bottom: 4px; margin-left: 0;`;
                bubbleContainer.appendChild(nameLabel);
            }

            // 4. Create and populate the main bubble
            const bubble = document.createElement('div');
            bubble.setAttribute('ontouchstart', `handleMsgTouchStart(${idx}, event)`);
            bubble.setAttribute('ontouchend', `handleMsgTouchEnd()`);
            bubble.setAttribute('onmousedown', `handleMsgMouseDown(${idx}, event)`);
            bubble.setAttribute('onmouseup', `handleMsgMouseUp()`);
            bubble.setAttribute('oncontextmenu', 'event.preventDefault()');

            // --- Bubble Content Logic (using innerHTML for complex parts is acceptable here) ---
            switch (m.type) {
                case 'transfer':
                case 'transfer_receipt':
                    const isReceipt = m.type === 'transfer_receipt';
                    const [amt, note] = isReceipt ? (m.content || '').split('|') : m.content.split('|');
                    let title = isMe ? (isReceipt ? (m.status === 'received' ? '你已收款' : '你已退还') : '转账给对方') : '转账给你';
                    let icon = 'yen-sign';
                    let statusClass = '';

                    if (m.status === 'received') { title = '已收款'; icon = 'check'; statusClass = 'done'; } 
                    else if (m.status === 'returned') { title = '已退回'; icon = 'undo'; statusClass = 'done'; }
                    
                    bubble.className = `bubble-transfer ${statusClass} ${selectedMsgs.has(idx) ? 'selected' : ''}`;
                    if (!isReceipt) bubble.onclick = () => receiveTransfer(idx, m.sender);
                    bubble.innerHTML = `<div class="transfer-top"><div class="transfer-icon"><i class="fas fa-${icon}"></i></div><div class="transfer-info"><div class="transfer-amt">￥${amt}</div><div class="transfer-desc">${note || title}</div></div></div><div class="transfer-bottom">微信转账</div>`;
                    break;
                case 'location':
                    bubble.className = `bubble-location ${selectedMsgs.has(idx) ? 'selected' : ''}`;
                    bubble.innerHTML = `<div class="loc-map"></div><div class="loc-info"><div class="loc-name">${m.content}</div><div class="loc-addr">未知地址</div></div>`;
                    break;
                case 'image':
                    bubble.className = `bubble ${selectedMsgs.has(idx) ? 'selected' : ''}`;
                    bubble.style.cssText = 'background: transparent; border: none; padding: 0;';
                    const img = document.createElement('img');
                    img.src = m.content;
                    img.style.cssText = "max-width: 140px; border-radius: 4px;";
                    img.onclick = () => showBigImg(m.content);
                    bubble.appendChild(img);
                    break;
                case 'voice':
                    if (m.showText) {
                        bubble.className = `bubble ${selectedMsgs.has(idx) ? 'selected' : ''}`;
                        bubble.innerText = m.textVal || '...';
                    } else {
                        bubble.className = `bubble voice ${selectedMsgs.has(idx) ? 'selected' : ''}`;
                        bubble.innerHTML = `<i class="fas fa-play" style="margin-right: 5px;"></i> ${m.content}`;
                    }
                    bubble.onclick = () => playVoiceMessage(idx);
                    break;
                default: // 'text'
                    bubble.className = `bubble ${selectedMsgs.has(idx) ? 'selected' : ''}`;
                    bubble.innerText = m.content;
                    break;
            }

            bubbleContainer.appendChild(bubble);
            
            // 5. Assemble the row and append to history
            row.appendChild(avatarImg);
            row.appendChild(bubbleContainer);
            history.appendChild(row);

            // 6. Scroll to bottom
            if (history.scrollHeight > history.clientHeight) {
                history.scrollTop = history.scrollHeight;
            }
        }

        // --- INTERACTION ---
        function openCustomInput(type) {
             customInputType = type;
             const m = document.getElementById('modal-custom-input');
             const t = document.getElementById('custom-input-title');
             const i = document.getElementById('custom-input-val');
             const d = document.getElementById('custom-input-date');
             const a = document.getElementById('custom-input-area');
             
             m.style.display = 'flex';
             i.value = ''; a.value = ''; d.value = '';
             i.style.display = 'block'; a.style.display = 'none'; d.style.display = 'none';

             if(type==='voice-fake') { t.innerText = "伪装语音 (输入文字)"; a.style.display='block'; i.style.display='none'; }
             if(type==='image-fake') { t.innerText = "伪装图片 (输入描述)"; a.style.display='block'; i.style.display='none'; }
             if(type==='transfer') { t.innerText = "转账 (金额)"; }
             if(type==='location') { t.innerText = "发送位置 (名称)"; }
             if(type==='recharge') { t.innerText = "充值 (金额)"; }
             if(type==='moment-text') { t.innerText = "发动态"; a.style.display='block'; i.style.display='none'; }
             if(type==='festival') { t.innerText = "添加节日"; d.style.display='block'; i.style.display='none'; }
             if(type==='wish') { t.innerText = "许愿 (内容)"; a.style.display='block'; i.style.display='none'; }
             if(type==='new-diary') { t.innerText = "写日记 (标题)"; a.style.display='block'; a.placeholder="内容..."; i.placeholder="标题"; i.style.display='block'; }
        }

        function confirmCustomInput() {
             let val = '';
             if(['voice-fake','image-fake','moment-text','wish'].includes(customInputType)) val = document.getElementById('custom-input-area').value;
             else if(customInputType==='festival') val = document.getElementById('custom-input-date').value;
             else if(customInputType==='new-diary') val = document.getElementById('custom-input-val').value;
             else val = document.getElementById('custom-input-val').value;
             
             if(!val) return;
             
             if(customInputType==='voice-fake') {const sec = Math.min(60, Math.max(1, Math.ceil(val.length / 3)));
                  if(!store.chats[activeChatId]) store.chats[activeChatId] = [];
                  const msgObj = { sender: 'me', type: 'voice', content: sec+"'", textVal: val, time: Date.now() };
                  store.chats[activeChatId].push(msgObj);
                  save(); 
                  appendMsgRow(msgObj, store.chats[activeChatId].length-1);
             }
             if(customInputType==='image-fake') {
                  // 使用 Canvas 本地生成，解决中文乱码
                  userSend('image', textToImage(val, '#cccccc', '#000000'));
             }
             if(customInputType==='transfer') {
                  const amt = parseFloat(val);
                  if(isNaN(amt)) return toast("金额无效");
                  if(store.user.balance < amt) return toast("余额不足");
                  store.user.balance -= amt;
                  store.bills.push({type:'out', amt, desc:'转账给'+store.contacts.find(x=>x.id===activeChatId)?.name, time:Date.now()});
                  userSend('transfer', `${amt}|转账`);
             }
             if(customInputType==='location') {
                  userSend('location', val);
             }
             if(customInputType==='recharge') {
                  const amt = parseFloat(val);
                  if(isNaN(amt)) return toast("金额无效");
                  store.user.balance += amt;
                  store.bills.push({type:'in', amt, desc:'充值', time:Date.now()});
                  save(); openWallet();
             }
             if(customInputType==='moment-text') {
                  postMoment(val, null);
             }
             if(customInputType==='festival') {
                  const n = prompt("节日名称");
                  if(n) { store.perception.festivals.push({name:n, date:val}); save(); renderPerception(); }
             }
             if(customInputType==='wish') {
                  store.couple.wishes.push({id:Date.now(), text:val, author:'me', reply:''});
                  save(); renderCouple();
                  aiGenerate('wish_reply::'+val);
             }
             if(customInputType==='new-diary') {
                 const content = document.getElementById('custom-input-area').value;
                 if(activeDiaryContactId) {
                     if(!store.diaries[activeDiaryContactId]) store.diaries[activeDiaryContactId] = [];
                     store.diaries[activeDiaryContactId].push({title: val, content: content, date: new Date().toLocaleString(), time: Date.now()});
                     save();
                     // Refresh detail view if open
                     openDiaryDetail(activeDiaryContactId);
                 }
             }
             
             save(); document.getElementById('modal-custom-input').style.display='none';
        }

        function startVoice() { toast("正在录音..."); }
        function endVoice() { 
            const t = prompt("录音内容 (转文字):");
            if(t) {
                if(!store.chats[activeChatId]) store.chats[activeChatId] = [];
                const msgObj = { sender: 'me', type: 'voice', content: Math.floor(Math.random()*10+2)+"'", textVal: t, time: Date.now() };
                store.chats[activeChatId].push(msgObj);
                save(); 
                appendMsgRow(msgObj, store.chats[activeChatId].length-1);
            }
        }
        function toggleVoiceText(idx) {
            const m = store.chats[activeChatId][idx];
            m.showText = !m.showText;
            save(); renderHistory();
        }
        function userSend(type, val) {
            const txt = val ||document.getElementById('chat-input').value;
            if(!txt && type==='text') return;
            
            if(type==='emoji') {
                 const emojis = ['😀','😂','🥰','😎','🤔','👍','🤝','❤️'];
                 const e = emojis[Math.floor(Math.random()*emojis.length)];
                 if(!store.chats[activeChatId]) store.chats[activeChatId] = [];
                 const msgObj = { sender: 'me', type: 'text', content: e, time: Date.now() };
                 store.chats[activeChatId].push(msgObj);
                 save(); 
                 appendMsgRow(msgObj, store.chats[activeChatId].length-1);
                 return;
            }

            if(!store.chats[activeChatId]) store.chats[activeChatId] = [];
            const msgObj = { sender: 'me', type, content: txt, time: Date.now() };
            
            if(quoteContent) {
                msgObj.quote = quoteContent;
                cancelQuote();
            }

            store.chats[activeChatId].push(msgObj);
            const c = store.contacts.find(x=>x.id===activeChatId);
            if (c) c.lastMsgTime = Date.now();
            save(); 
            appendMsgRow(msgObj, store.chats[activeChatId].length-1);
            document.getElementById('chat-input').value = '';
            
            // Trigger AI response after a short delay
            setTimeout(() => aiGenerate(), 500);
        }
        function receiveTransfer(idx, sender) {
            const m = store.chats[activeChatId][idx];
            
            // If I sent it
            if(sender === 'me') {
                if(m.status === 'received') return toast("对方已收款");
                if(m.status === 'returned') return toast("钱款已退回");
                return toast("等待对方确认");
            }
            
            // If I received it
            if(m.status) return toast(m.status === 'received' ? "已收款" : "已退回");
            
            currentTransferMsgIdx = idx;
            document.getElementById('modal-transfer-action').style.display = 'flex';
        }

        function handleTransferAction(action) {
            const idx = currentTransferMsgIdx;
            if(idx === -1 || !store.chats[activeChatId]) return;
            
            const m = store.chats[activeChatId][idx];
            const amt = parseFloat(m.content.split('|')[0]);
            
            if(action === 'receive') {
                m.status = 'received';
                store.user.balance += amt;
                store.bills.push({type:'in', amt, desc:'收到转账', time:Date.now()});
                store.chats[activeChatId].push({ sender: 'me', type: 'transfer_receipt', status: 'received', time: Date.now() });
                toast(`已收款 ￥${amt}`);
            } else if(action === 'return') {
                m.status = 'returned';
                // Note: Logic for returning money to sender (AI) is just visual here, AI balance not tracked.
                store.chats[activeChatId].push({ sender: 'me', type: 'transfer_receipt', status: 'returned', time: Date.now() });
                toast("已退回转账");
            }
            
            save(); renderHistory();
            document.getElementById('modal-transfer-action').style.display = 'none';
        }
        function showThought() {
            const msgs = store.chats[activeChatId]||[];
            if(msgs.length>0 && msgs[msgs.length-1].sender==='ai' && msgs[msgs.length-1].heart) {
                const heartData = msgs[msgs.length-1].heart.split('|');
                const html = `
                    <div style="font-size:14px; margin-bottom:5px;"><strong>位置:</strong> ${heartData[0]||'未知'}</div>
                    <div style="font-size:14px; margin-bottom:5px;"><strong>穿着:</strong> ${heartData[1]||'未知'}</div>
                    <div style="font-size:14px; margin-bottom:5px;"><strong>状态:</strong> ${heartData[2]||'未知'}</div>
                    <div style="font-size:14px; margin-top:10px; border-top:1px solid #eee; padding-top:10px;">${heartData[3]||'无想法'}</div>
                `;
                document.getElementById('thought-text').innerHTML = html;
                document.getElementById('modal-thought').style.display = 'flex';
            } else {
                toast("暂无心声");
            }
        }
        
        // --- CONTACTS ---
        function openContactModal() {
            document.getElementById('modal-contact').style.display = 'flex';
            document.getElementById('new-contact-name').value = '';
            document.getElementById('new-contact-persona').value = '';
            document.getElementById('new-contact-img').src = '';
            document.getElementById('new-contact-img').style.display='none';
        }
        function createContact() {
            const name = document.getElementById('new-contact-name').value;
            const persona = document.getElementById('new-contact-persona').value;
            const img = document.getElementById('new-contact-img').src;
            if(!name) return toast("请输入名字");
            
            store.contacts.push({
                id: 'c'+Date.now(), name, avatar: img || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`,
                persona: persona,
                settings: { 
                    autoMsg: false, autoMsgInterval: 30, autoMoment: false, autoDiary: false, diaryTime: '22:00', time: '', wb: '', userPersona: 'p1', bg: '', stickerGallery: '',
                    enablePerception: true, userVirtualCity: '', userRealCity: '', aiVirtualCity: '', aiRealCity: ''
                },
                pinned: false
            });
            save(); renderContacts(); document.getElementById('modal-contact').style.display='none';
        }
        
        function renderContacts() {
            const list = document.getElementById('contact-list');
            list.innerHTML = ''; // Clear previous content

            const sorted = [...store.contacts].sort((a, b) => {
                if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;
                if (a.isGroup !== b.isGroup) return a.isGroup ? -1 : 1;
                return 0; // Or add further sorting by name/time
            });

            // Use a DocumentFragment for batch appending to improve performance
            const fragment = document.createDocumentFragment();

            sorted.forEach(c => {
                const item = document.createElement('div');
                item.className = 'list-item';
                if (c.pinned) item.style.background = '#f7f7f7';

                item.onclick = () => { if (!isLongPress) openChat(c.id); };
                item.ontouchstart = (e) => handleContactTouchStart(c.id, e);
                item.ontouchend = handleContactTouchEnd;
                item.onmousedown = (e) => handleContactMouseDown(c.id, e);
                item.onmouseup = handleContactMouseUp;
                item.oncontextmenu = (e) => e.preventDefault();

                // Avatar
                const avatar = document.createElement('img');
                avatar.src = c.avatar;
                avatar.className = 'avatar';
                item.appendChild(avatar);

                // Content
                const content = document.createElement('div');
                content.className = 'list-content';

                // Title
                const title = document.createElement('div');
                title.className = 'list-title';
                title.style.cssText = 'display:flex; align-items:center; gap:8px;';
                
                // Use textContent for security and performance
                const nameSpan = document.createElement('span');
                nameSpan.textContent = c.name;
                title.appendChild(nameSpan);

                if (c.isGroup) title.innerHTML += '<i class="fas fa-users" style="font-size:12px; color:#999;"></i>';
                if (c.pinned) title.innerHTML += '<i class="fas fa-thumbtack" style="font-size:12px; color:#ccc; margin-left:auto;"></i>';
                
                content.appendChild(title);

                // Subtitle
                let subText;
                const chatHistory = store.chats[c.id];
                if (chatHistory && chatHistory.length > 0) {
                    subText = getMsgText(chatHistory[chatHistory.length - 1]);
                } else {
                    subText = c.isGroup ? `群聊` : (c.persona || '');
                }
                const sub = document.createElement('div');
                sub.className = 'list-sub';
                sub.textContent = subText.substring(0, 22) + (subText.length > 22 ? '...' : '');
                content.appendChild(sub);

                item.appendChild(content);
                fragment.appendChild(item);
            });

            list.appendChild(fragment);
        }

        // --- GROUP CHAT ---
        function gotoAddGroup() {
            const layer = document.getElementById('layer-add-group');
            const list = document.getElementById('add-group-contact-list');
            
            const availableContacts = store.contacts.filter(c => !c.isGroup);
            
            selectedGroupContacts.clear();
            list.innerHTML = '';

            availableContacts.forEach(c => {
                list.innerHTML += `
                    <div class="list-item" onclick="toggleGroupContactSelect(this, '${c.id}')">
                        <div style="width:24px; height:24px; border:1px solid #ccc; border-radius:4px; margin-right:15px; display:flex; justify-content:center; align-items:center;" class="checkbox-icon">
                            <i class="fas fa-check" style="color:var(--primary); display:none;"></i>
                        </div>
                        <img src="${c.avatar}" class="avatar">
                        <div class="list-content">
                            <div class="list-title">${c.name}</div>
                        </div>
                    </div>
                `;
            });
            
            layer.classList.add('show');
            document.getElementById('wx-add-menu').style.display = 'none';
        }

        function toggleGroupContactSelect(el, contactId) {
            const checkbox = el.querySelector('.checkbox-icon i');
            if (selectedGroupContacts.has(contactId)) {
                selectedGroupContacts.delete(contactId);
                checkbox.style.display = 'none';
                el.style.background = '#fff';
            } else {
                selectedGroupContacts.add(contactId);
                checkbox.style.display = 'block';
                el.style.background = '#f7f7f7';
            }
        }

        function confirmCreateGroup() {
            if (selectedGroupContacts.size < 1) {
                return toast("请至少选择一位联系人");
            }

            const memberIds = Array.from(selectedGroupContacts);
            const members = store.contacts.filter(c => memberIds.includes(c.id));
            const groupName = `群聊 (${members.length + 1})`; // +1 for the user

            const newGroup = {
                id: 'g' + Date.now(),
                name: groupName,
                avatar: 'https://ui-avatars.com/api/?name=G&background=random&color=fff',
                isGroup: true,
                members: memberIds,
                settings: {
                     historyInteroperability: false,
                     enablePerception: true,
                }
            };

            store.contacts.unshift(newGroup); // Add to top of list
            save();
            renderContacts();
            closeLayer('layer-add-group');
            openChat(newGroup.id);
        }

        // --- CONTACT LONG PRESS ---
        function handleContactTouchStart(cid, e) {
            isLongPress = false;
            selectedContactId = cid;
            longPressTimer = setTimeout(() => { 
                isLongPress = true; 
                showContactMenu(e.touches[0].clientX, e.touches[0].clientY); 
            }, 500);
        }
        function handleContactTouchEnd() { 
            clearTimeout(longPressTimer);
        }
        function handleContactMouseDown(cid, e) {
            if(e.button !== 0) return; 
            isLongPress = false;
            selectedContactId = cid;
            longPressTimer = setTimeout(() => { 
                isLongPress = true; 
                showContactMenu(e.clientX, e.clientY); 
            }, 500);
        }
        function handleContactMouseUp() { 
            clearTimeout(longPressTimer);
        }
        
        function showContactMenu(x, y) {
            const menu = document.getElementById('contact-menu');
            const c = store.contacts.find(x=>x.id===selectedContactId);
            if(!c) return;
            
            document.getElementById('cm-pin').innerText = c.pinned ? "取消置顶" : "置顶聊天";
            
            menu.style.display = 'flex';
            
            // Measure first
            menu.style.visibility = 'hidden';
            menu.style.display = 'flex';
            const rect = menu.getBoundingClientRect();
            menu.style.visibility = 'visible';

            let finalX = x;
            let finalY = y;

            if (finalX + rect.width > window.innerWidth) {
                finalX = window.innerWidth - rect.width - 10;
            }
            if (finalX < 10) finalX = 10;

            if (finalY + rect.height > window.innerHeight) {
                finalY = window.innerHeight - rect.height - 10;
            }

            menu.style.left = finalX + 'px';
            menu.style.top = finalY + 'px';
            
            if(navigator.vibrate) navigator.vibrate(50);
        }
        
        function pinContact() {
            const c = store.contacts.find(x=>x.id===selectedContactId);
            if(c) {
                c.pinned = !c.pinned;
                save(); renderContacts();
                document.getElementById('contact-menu').style.display='none';
            }
        }
        
        function deleteContact() {
            const contact = store.contacts.find(x => x.id === selectedContactId);
            if (!contact) return;
            document.getElementById('contact-menu').style.display = 'none';
            showConfirm(
                `删除联系人`, 
                `确定要删除联系人 "${contact.name}" 吗？所有相关数据都将被清除。`,
                () => thoroughDeleteContact(selectedContactId)
            );
        }

        // --- MSG LONG PRESS & MENU ---
        function handleMsgTouchStart(idx, e) {
            isLongPress = false;
            if(isMultiSelect) { toggleSelectMsg(idx); return; }
            selectedMsgIdx = idx;
            longPressTimer = setTimeout(() => { 
                isLongPress = true; 
                showMsgMenu(e.touches[0].clientX, e.touches[0].clientY); 
            }, 500);
        }
        function handleMsgTouchEnd() { 
            clearTimeout(longPressTimer);
        }
        function handleMsgMouseDown(idx, e) {
            if(isMultiSelect) { toggleSelectMsg(idx); return; }
            if(e.button !== 0) return;
            isLongPress = false;
            selectedMsgIdx = idx;
            longPressTimer = setTimeout(() => { 
                isLongPress = true; 
                showMsgMenu(e.clientX, e.clientY); 
            }, 500);
        }
        function handleMsgMouseUp() { 
            clearTimeout(longPressTimer);
        }

        function showMsgMenu(x, y) {
            const menu = document.getElementById('msg-menu');
            menu.style.display = 'flex';
            
            // Measure
            menu.style.visibility = 'hidden';
            menu.style.display = 'flex';
            const rect = menu.getBoundingClientRect();
            menu.style.visibility = 'visible';

            let finalX = x;
            let finalY = y;

            if (finalX + rect.width > window.innerWidth) {
                finalX = window.innerWidth - rect.width - 10;
            }
            if (finalX < 10) finalX = 10;

            if (finalY + rect.height > window.innerHeight) {
                finalY = window.innerHeight - rect.height - 10;
            }

            menu.style.left = finalX + 'px';
            menu.style.top = finalY + 'px';
            
            if(navigator.vibrate) navigator.vibrate(50);
        }

        function menuQuote() {
            const m = store.chats[activeChatId][selectedMsgIdx];
            if(!m) return;
            quoteContent = (m.sender==='me'?'我':store.contacts.find(c=>c.id===activeChatId).name) + ": " + getMsgText(m);
            document.getElementById('quote-text').innerText = quoteContent;
            document.getElementById('quote-preview').style.display = 'flex';
            document.getElementById('msg-menu').style.display='none';
        }

        function cancelQuote() {
            quoteContent = null;
            document.getElementById('quote-preview').style.display = 'none';
        }

        function menuCopy() {
            const m = store.chats[activeChatId][selectedMsgIdx];
            if(m) {
                const text = getMsgText(m);
                navigator.clipboard.writeText(text).then(()=>toast("已复制"));
            }
            document.getElementById('msg-menu').style.display='none';
        }

        function menuEdit() {
            const m = store.chats[activeChatId][selectedMsgIdx];
            if(m) {
                const newText = prompt("编辑消息:", m.content);
                if(newText !== null && newText !== m.content) {
                    m.content = newText;
                    if(m.type === 'voice') m.textVal = newText;
                    save(); renderHistory();
                }
            }
            document.getElementById('msg-menu').style.display='none';
        }

        function menuSelect() {
            isMultiSelect = true;
            document.getElementById('chat-select-bar').style.display = 'flex';
            toggleSelectMsg(selectedMsgIdx);
            document.getElementById('msg-menu').style.display='none';
        }
        
        function toggleSelectMsg(idx) {
            if(selectedMsgs.has(idx)) selectedMsgs.delete(idx);
            else selectedMsgs.add(idx);
            renderHistory();
        }

        function cancelSelect() {
            isMultiSelect = false;
            selectedMsgs.clear();
            document.getElementById('chat-select-bar').style.display = 'none';
            renderHistory();
        }

        function deleteSelected() {
            if(selectedMsgs.size === 0) return;
            if(confirm(`删除选中的 ${selectedMsgs.size} 条消息?`)) {
                const sorted = Array.from(selectedMsgs).sort((a,b)=>b-a);
                sorted.forEach(idx => {
                    store.chats[activeChatId].splice(idx, 1);
                });
                cancelSelect();
                save();
            }
        }
        
        function menuDelete() {
             if(confirm("删除这条消息?")) {
                 store.chats[activeChatId].splice(selectedMsgIdx, 1);
                 save(); renderHistory();
             }
             document.getElementById('msg-menu').style.display='none';
        }

        function getMsgText(m) {
            if(m.type==='text') return m.content;
            if(m.type==='voice') return m.textVal || '[语音]';
            if(m.type==='image') return '[图片]';
            if(m.type==='transfer') return '[转账]';
            if(m.type==='location') return '[位置] ' + m.content;
            return m.content;
        }
        
        // Close menu on click elsewhere (Duplicate logic handled in window.onclick above, removing this listener)

        // --- CHAT SETTINGS ---
        function openChatSettings() {
             const c = store.contacts.find(x=>x.id===activeChatId);
             if(!c) return;
             document.getElementById('layer-chat-settings').classList.add('show');
             
             if(!c.settings) c.settings = { autoMsg: false, autoMsgInterval: 30, autoMoment: false, autoDiary: false, diaryTime: '22:00', time: '', wb: '', userPersona: 'p1', bg: '', stickerGallery: '' };
             
             let settingsHTML = '';
             if (c.isGroup) {
                // [FIX-1] 恢复群聊核心设置界面
                const wbOpts = [{id:'',name:'无'}].concat(store.worldbooks||[]).map(w=>`<option value="${w.id}" ${c.settings.wb===w.id?'selected':''}>${w.name}</option>`).join('');
                const allCates = store.stickerCategories || [];
                const currentCateIds = c.settings.mountedCateIds || [];
                
                settingsHTML = `
                <div style="text-align:center; padding:20px;">
                    <div class="upload-box" style="width:80px; height:80px; border-radius:50%; margin:0 auto; background:#fff;" onclick="uploadImg('edit-contact-avatar')"><img src="${c.avatar}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;"></div>
                    <input id="edit-c-name" value="${c.name}" style="margin-top:10px; text-align:center; border:none; background:transparent; font-size:18px; font-weight:bold;">
                </div>
                <div class="group-box">
                     <div class="form-cell"><span class="form-label">历史互通 (记忆共享)</span><div class="switch"><input type="checkbox" id="edit-c-history" ${c.settings.historyInteroperability?'checked':''}><span class="slider"></span></div></div>
                </div>
                <div class="group-box">
                    <div class="form-cell"><span class="form-label">挂载世界书</span><select id="edit-c-wb" style="border:none; bg:transparent; width:150px;">${wbOpts}</select></div>
                    <div class="form-cell" onclick="toggleStickerMount()"><span class="form-label">挂载表情分类</span><span class="form-val" id="sticker-count">${currentCateIds.length}个</span><i class="fas fa-chevron-right form-arrow"></i></div>
                    <div id="sticker-mount-area" style="display:none; padding:10px; background:#f9f9f9; flex-direction:column; gap:5px;">
                        ${allCates.length>0 ? allCates.map(cate => `<div onclick="toggleStickerSelect(this, '${cate.id}')" class="sticker-select-item" style="padding:10px; border:1px solid ${currentCateIds.includes(cate.id)?'#07c160':'#ddd'}; border-radius:6px; cursor:pointer; background:#fff; display:flex; justify-content:space-between; align-items:center;"><span>${cate.name}</span> ${currentCateIds.includes(cate.id) ? '<i class="fas fa-check" style="color:#07c160;"></i>' : ''}</div>`).join('') : '<div style="font-size:12px; color:#999;">无分类</div>'}
                    </div>
                </div>
                 <div class="group-box">
                     <div class="form-cell"><span class="form-label">聊天背景</span><button onclick="uploadImg('chat-bg')" style="font-size:12px; padding:5px 10px;">上传</button></div>
                     <div class="form-cell"><span class="form-label">天气与时间感知</span><div class="switch"><input type="checkbox" id="edit-c-perc-en" ${c.settings.enablePerception!==false?'checked':''}><span class="slider"></span></div></div>
                </div>
                `;
             } else {
                // Full settings for private chat
                const wbOpts = [{id:'',name:'无'}].concat(store.worldbooks||[]).map(w=>`<option value="${w.id}" ${c.settings.wb===w.id?'selected':''}>${w.name}</option>`).join('');
                const pOpts = store.personas.map(p=>`<option value="${p.id}" ${c.settings.userPersona===p.id?'selected':''}>${p.name}</option>`).join('');
                const allCates = store.stickerCategories || [];
                const currentCateIds = c.settings.mountedCateIds || [];
                
                settingsHTML = `
                    <div style="text-align:center; padding:20px;">
                        <div class="upload-box" style="width:80px; height:80px; border-radius:50%; margin:0 auto; background:#fff;" onclick="uploadImg('edit-contact-avatar')"><img src="${c.avatar}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;"></div>
                        <input id="edit-c-name" value="${c.name}" style="margin-top:10px; text-align:center; border:none; background:transparent; font-size:18px; font-weight:bold;">
                    </div>
                    <div class="group-box">
                        <div class="form-cell" style="flex-direction:column; align-items:center;">
                            <span class="form-label" style="font-weight:bold; margin-bottom:5px;">人设</span>
                            <textarea id="edit-c-persona" style="width:100%; height:100px; border:1px solid #eee; padding:5px; resize:none; border-radius:5px;">${c.persona || ''}</textarea>
                        </div>
                    </div>
                    <div class="group-box">
                        <div class="form-cell"><span class="form-label">世界书</span><select id="edit-c-wb" style="border:none; bg:transparent; width:150px;">${wbOpts}</select></div>
                        <div class="form-cell"><span class="form-label">我的身份</span><select id="edit-c-up" style="border:none; bg:transparent; width:150px;">${pOpts}</select></div>
                        <div class="form-cell"><span class="form-label">聊天背景</span><button onclick="uploadImg('chat-bg')" style="font-size:12px; padding:5px 10px;">上传</button></div>
                        <div class="form-cell" onclick="toggleStickerMount()"><span class="form-label">挂载表情分类</span><span class="form-val" id="sticker-count">${currentCateIds.length}个</span><i class="fas fa-chevron-right form-arrow"></i></div>
                        <div id="sticker-mount-area" style="display:none; padding:10px; background:#f9f9f9; flex-direction:column; gap:5px;">
                            ${allCates.length>0 ? allCates.map(cate => `<div onclick="toggleStickerSelect(this, '${cate.id}')" class="sticker-select-item" style="padding:10px; border:1px solid ${currentCateIds.includes(cate.id)?'#07c160':'#ddd'}; border-radius:6px; cursor:pointer; background:#fff; display:flex; justify-content:space-between; align-items:center;"><span>${cate.name}</span> ${currentCateIds.includes(cate.id) ? '<i class="fas fa-check" style="color:#07c160;"></i>' : ''}</div>`).join('') : '<div style="font-size:12px; color:#999;">无分类</div>'}
                        </div>
                    </div>
                    <div class="group-box">
                        <div class="form-cell"><span class="form-label">主动发消息</span><div class="switch"><input type="checkbox" id="edit-c-auto" ${c.settings.autoMsg?'checked':''}><span class="slider"></span></div></div>
                        <div class="form-cell"><span class="form-label">主动间隔(分)</span><input type="number" id="edit-c-auto-int" value="${c.settings.autoMsgInterval||30}" style="width:50px; text-align:right;"></div>
                        <div class="form-cell"><span class="form-label">主动发动态</span><div class="switch"><input type="checkbox" id="edit-c-auto-mom" ${c.settings.autoMoment?'checked':''}><span class="slider"></span></div></div>
                        <div class="form-cell"><span class="form-label">定时写日记</span><div class="switch"><input type="checkbox" id="edit-c-auto-dia" ${c.settings.autoDiary?'checked':''}><span class="slider"></span></div></div>
                        <div class="form-cell"><span class="form-label">日记时间</span><input type="time" id="edit-c-dia-time" value="${c.settings.diaryTime||'22:00'}" style="border:none;"></div>
                    </div>
                    <h3 style="margin:10px 15px; color:#555;">感知设置</h3>
                    <div class="group-box">
                        <div class="form-cell"><span class="form-label">天气与时间感知</span><div class="switch"><input type="checkbox" id="edit-c-perc-en" ${c.settings.enablePerception!==false?'checked':''}><span class="slider"></span></div></div>
                        <div class="form-cell" style="flex-direction:column; align-items:flex-start; background:#f9f9f9;"><span class="form-label" style="font-size:14px; font-weight:bold; margin-bottom:5px;">用户所在地</span><div style="width:100%; display:flex; gap:10px; margin-bottom:5px;"><input id="edit-c-user-v-city" placeholder="虚拟城市" value="${c.settings.userVirtualCity||''}" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;"><input id="edit-c-user-r-city" placeholder="真实城市" value="${c.settings.userRealCity||''}" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;"></div></div>
                        <div class="form-cell" style="flex-direction:column; align-items:flex-start; background:#f9f9f9;"><span class="form-label" style="font-size:14px; font-weight:bold; margin-bottom:5px;">AI 所在地 (留空则同用户)</span><div style="width:100%; display:flex; gap:10px; margin-bottom:5px;"><input id="edit-c-ai-v-city" placeholder="虚拟城市" value="${c.settings.aiVirtualCity||''}" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;"><input id="edit-c-ai-r-city" placeholder="真实城市" value="${c.settings.aiRealCity||''}" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px;"></div></div>
                    </div>
                `;
             }
             document.getElementById('chat-settings-content').innerHTML = settingsHTML;
             
             const btn = document.getElementById('btn-pin-contact');
             if(btn) {
                 btn.innerText = c.pinned ? "取消置顶" : "置顶";
                 btn.style.background = c.pinned ? "#ddd" : "#576b95";
                 btn.style.color = c.pinned ? "#333" : "#fff";
             }
        }
        let tempMountedCateIds = [];
        
        function toggleStickerMount() {
            const area = document.getElementById('sticker-mount-area');
            const c = store.contacts.find(x=>x.id===activeChatId);
            if(!c) return;
            // Init temp list
            tempMountedCateIds = c.settings.mountedCateIds || [];
            area.style.display = area.style.display === 'none' ? 'flex' : 'none';
        }
        
        function toggleStickerSelect(el, id) {
            if(tempMountedCateIds.includes(id)) {
                tempMountedCateIds = tempMountedCateIds.filter(x=>x!==id);
                el.style.borderColor = '#ddd';
                el.querySelector('.fa-check')?.remove();
            } else {
                tempMountedCateIds.push(id);
                el.style.borderColor = '#07c160';
                if(!el.querySelector('.fa-check')) el.innerHTML += '<i class="fas fa-check" style="color:#07c160;"></i>';
            }
            document.getElementById('sticker-count').innerText = tempMountedCateIds.length + '个';
        }

        function saveChatSettings() {
            const c = store.contacts.find(x=>x.id===activeChatId);
            if(!c) return;
            
            // [FIX-1] 重构设置保存逻辑，兼容群聊和私聊
            // 通用设置
            c.name = document.getElementById('edit-c-name').value;
            c.settings.enablePerception = document.getElementById('edit-c-perc-en').checked;

            if (c.isGroup) {
                // 仅群聊设置
                c.settings.historyInteroperability = document.getElementById('edit-c-history').checked;
                c.settings.wb = document.getElementById('edit-c-wb').value;
            } else { 
                // 仅私聊设置
                c.persona = document.getElementById('edit-c-persona').value;
                c.settings.wb = document.getElementById('edit-c-wb').value;
                c.settings.userPersona = document.getElementById('edit-c-up').value;
                c.settings.autoMsg = document.getElementById('edit-c-auto').checked;
                c.settings.autoMsgInterval = parseInt(document.getElementById('edit-c-auto-int').value);
                c.settings.autoMoment = document.getElementById('edit-c-auto-mom').checked;
                c.settings.autoDiary = document.getElementById('edit-c-auto-dia').checked;
                c.settings.diaryTime = document.getElementById('edit-c-dia-time').value;
                c.settings.userVirtualCity = document.getElementById('edit-c-user-v-city').value;
                c.settings.userRealCity = document.getElementById('edit-c-user-r-city').value;
                c.settings.aiVirtualCity = document.getElementById('edit-c-ai-v-city').value;
                c.settings.aiRealCity = document.getElementById('edit-c-ai-r-city').value;
            }

            // 通用的挂载表情包设置
            const area = document.getElementById('sticker-mount-area');
            if(area && area.style.display !== 'none') {
                c.settings.mountedCateIds = [...tempMountedCateIds];
            }
            
            save(); 
            renderContacts(); 
            document.getElementById('chat-title').innerText = c.name; 
            toast("设置已保存");
        }
        
        function pinContactToggle() {
            const c = store.contacts.find(x=>x.id===activeChatId);
            if(c) {
                c.pinned = !c.pinned;
                save(); renderContacts();
                const btn = document.getElementById('btn-pin-contact');
                if(btn) {
                    btn.innerText = c.pinned ? "取消置顶" : "置顶";
                    btn.style.background = c.pinned ? "#ddd" : "#576b95";
                    btn.style.color = c.pinned ? "#333" : "#fff";
                }
                toast(c.pinned ? "已置顶" : "已取消置顶");
            }
        }
        
        function deleteContactFromSettings() {
            const contact = store.contacts.find(x => x.id === activeChatId);
            if (!contact) return;
            showConfirm(
                `删除联系人`,
                `确定要删除联系人 "${contact.name}" 吗？此操作将清除该联系人的聊天记录、日记、动态等所有数据，且不可恢复。`,
                () => thoroughDeleteContact(activeChatId, true)
            );
        }

        function thoroughDeleteContact(contactId, fromSettings = false) {
            const contact = store.contacts.find(x => x.id === contactId);
            if (!contact) return;

            const name = contact.name;

            // 1. Delete Contact
            store.contacts = store.contacts.filter(x => x.id !== contactId);
            
            // 2. Delete Chat History
            delete store.chats[contactId];
            
            // 3. Delete Diaries
            delete store.diaries[contactId];
            
            // 4. Delete Moments (by name)
            if (name) {
                store.moments = store.moments.filter(m => m.name !== name);
            }
            
            // 5. Unbind from Couple space if they are the partner
            if (store.couple.partnerId === contactId) {
                store.couple = { partnerId: null, start: '', wishes: [], anniversaries: [], cycleDate: '', cycleLen: 28 };
            }

            save();
            renderContacts();
            renderMoments(); // Refresh moments as some might be deleted
            toast(`已彻底删除联系人: ${name}`);

            if (fromSettings) {
                document.getElementById('layer-chat-settings').classList.remove('show');
                document.getElementById('layer-chat').classList.remove('show');
            }
        }

        function saveSysSettings() {
             let url = document.getElementById('sys-url').value;
             if(url.endsWith('/')) url = url.slice(0,-1);
             store.system.url = url;
             store.system.key = document.getElementById('sys-key').value;
             store.system.model = document.getElementById('sys-model').value;
             store.system.minimaxKey = document.getElementById('sys-minimax-key').value;
             save(); toast("系统配置已保存");
        }

        async function fetchModels() {
             const url = document.getElementById('sys-url').value;
             const key = document.getElementById('sys-key').value;
             toast("正在拉取模型...");
             try {
                 const data = await API.fetchModels(url, key);
                 const models = Array.isArray(data) ? data : (data.data || []);
                 
                 const sel = document.getElementById('sys-model');
                 sel.innerHTML = '';
                 models.forEach(m => {
                     const opt = document.createElement('option');
                     const id = m.id || m;
                     opt.value = id; opt.innerText = id;
                     sel.appendChild(opt);
                 });
                 
                 store.system.url = url;
                 store.system.key = key;
                 if(models.length > 0 && !models.find(m => (m.id || m) === store.system.model)) {
                     store.system.model = (models[0].id || models[0]);
                 }
                 save(); 
                 toast("模型列表已更新");
             } catch(e) {
                 console.error(e);
                 // Error toast handled by API module
             }
        }

        async function fetchModelsForPreset() {
             const url = document.getElementById('preset-url').value;
             const key = document.getElementById('preset-key').value;
             toast("正在拉取...");
             try {
                 const data = await API.fetchModels(url, key);
                 const models = Array.isArray(data) ? data : (data.data || []);
                 
                 if(models.length > 0) {
                     const input = document.getElementById('preset-model');
                     const modelNames = models.map(m => m.id || m);
                     input.value = modelNames[0]; // Default to first
                     
                     const p = document.getElementById('modal-picker');
                     const l = document.getElementById('picker-list');
                     document.getElementById('picker-title').innerText = "选择模型";
                     l.innerHTML = modelNames.map(m => `<div class="list-item" onclick="document.getElementById('preset-model').value='${m}'; document.getElementById('modal-picker').style.display='none'">${m}</div>`).join('');
                     p.style.display='flex';
                     
                     toast("拉取成功，请选择");
                 } else {
                     toast("未找到模型");
                 }
             } catch(e) {
                 console.error(e);
                 // Error toast handled by API module
             }
        }

        // --- API PRESETS ---
        function renderAPIPresets() {
            const list = document.getElementById('api-preset-list');
            if(!store.apiPresets) store.apiPresets = [];
            
            list.innerHTML = store.apiPresets.length === 0 ? '<div style="padding:20px; text-align:center; color:#999;">暂无预设</div>' : '';
            
            store.apiPresets.forEach((p,i) => {
                list.innerHTML += `<div class="form-cell">
                        <span class="form-label">${p.name}</span>
                        <button onclick="loadAPIPreset(${i})" style="padding:5px 10px; border:none; background:var(--primary); color:#fff; border-radius:4px; margin-right:10px;">加载</button><button onclick="deleteAPIPreset(${i})" style="padding:5px 10px; border:none; background:#fa5151; color:#fff; border-radius:4px;">删除</button>
                    </div>
                `;
            });
        }

        function openAPIPresetModal() {
            document.getElementById('modal-api-preset').style.display = 'flex';
            document.getElementById('preset-name').value = '';
            document.getElementById('preset-url').value = '';
            document.getElementById('preset-key').value = '';
            document.getElementById('preset-model').value = '';
        }

        function saveAPIPreset() {
            const name = document.getElementById('preset-name').value;
            const url = document.getElementById('preset-url').value;
            const key = document.getElementById('preset-key').value;
            const model = document.getElementById('preset-model').value;
            
            if(!name || !url || !key || !model) return toast("请填写完整信息");
            
            if(!store.apiPresets) store.apiPresets = [];
            store.apiPresets.push({name, url, key, model});
            save(); renderAPIPresets();document.getElementById('modal-api-preset').style.display = 'none';
            toast("预设已保存");
        }

        function loadAPIPreset(idx) {
            const p = store.apiPresets[idx];
            document.getElementById('sys-url').value = p.url;
            document.getElementById('sys-key').value = p.key;
            
            const sel = document.getElementById('sys-model');
            let found = false;
            for(let i=0; i<sel.options.length; i++) {
                if(sel.options[i].value === p.model) { found = true; break; }
            }
            if(!found) {
                const opt = document.createElement('option');
                opt.value = p.model; opt.innerText = p.model;
                sel.appendChild(opt);
            }
            sel.value = p.model;
            
            toast("预设已加载: " + p.name);
        }

        function deleteAPIPreset(idx) {
            if(confirm("确定删除此预设?")) {
                store.apiPresets.splice(idx, 1);
                save(); renderAPIPresets();
            }
        }

        // --- MOMENTS ---
        function renderMoments() {
            const feed = document.getElementById('moments-feed');
            const bg = store.user.momentBg || 'https://via.placeholder.com/800x600/333/666';
            feed.innerHTML = `<div style="height:300px; background:url(${bg}) center/cover; position:relative;" onclick="uploadImg('moment-bg')">
                <div style="position:absolute; bottom:-20px; right:20px; display:flex; align-items:flex-end;">
                    <div style="color:#fff; font-weight:bold; margin-bottom:30px; margin-right:10px; text-shadow:0 1px 2px #000;">${store.user.name}</div>
                    <img src="${store.user.avatar||'https://via.placeholder.com/100'}" style="width:70px; height:70px; border-radius:8px; border:2px solid #fff; background:#fff;">
                </div>
            </div><div style="height:40px;"></div>`;
            
            store.moments.forEach((m, idx) => {
                const liked = m.likes && m.likes.includes('me');
                const likeColor = liked ? '#fa5151' : '#576b95';
                const comments = m.comments || [];
                
                feed.innerHTML += `<div style="padding:15px; border-bottom:1px solid #eee; background:#fff;">
                    <div style="display:flex; gap:10px;">
                        <img src="${m.avatar}" class="avatar" style="width:40px; height:40px;">
                        <div style="flex:1;">
                            <div style="color:#576b95; font-weight:bold; font-size:15px;">${m.name}</div>
                            <div style="margin:5px 0; font-size:15px;">${m.content}</div>
                            ${m.img ? `<img src="${m.img}" onclick="showBigImg('${m.img}')" style="max-width:200px; max-height:200px; border-radius:4px; margin-top:5px; cursor:pointer;">` : ''}
                            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                                <span style="font-size:12px; color:#999;">${new Date(m.time).toLocaleTimeString()}</span>
                                <div style="display:flex; gap:15px; align-items:center;">
                                    <div onclick="toggleLike(${idx})" style="cursor:pointer; color:${likeColor}; display:flex; align-items:center; gap:4px;">
                                        <i class="${liked?'fas':'far'} fa-heart"></i> ${liked?'':'点赞'}
                                    </div>
                                    <div onclick="addComment(${idx})" style="cursor:pointer; color:#576b95; display:flex; align-items:center; gap:4px;">
                                        <i class="far fa-comment"></i> 评论
                                    </div>
                                    <i class="fas fa-trash" onclick="deleteMoment(${idx})" style="color:#ddd; cursor:pointer;"></i>
                                </div>
                            </div>
                            <!-- Likes & Comments Area -->
                            ${ (m.likes?.length>0 || comments.length>0) ? 
                                `<div style="background:#f7f7f7; padding:8px; margin-top:10px; border-radius:4px;">
                                    ${ m.likes?.length>0 ? `<div style="color:#576b95; font-size:13px; margin-bottom:5px;"><i class="far fa-heart"></i> ${m.likes.includes('me')?'我':''}${m.likes.length>1?', ...':''}</div>` : '' }
                                    ${ comments.map(cm => `<div style="font-size:13px; margin-bottom:2px;"><span style="color:#576b95; font-weight:500;">${cm.name}${cm.replyTo?` 回复 ${cm.replyTo}`:''}:</span> ${cm.text}</div>`).join('') }
                                </div>` : ''
                            }
                        </div>
                    </div>
                </div>`;
            });
        }
        
        function showMomentActionSheet() {
            document.getElementById('modal-moment-action').style.display='flex';
        }
        
        function postMoment(t, i) {
             const mId = Date.now();
             store.moments.unshift({
                 id: mId,
                 name: store.user.name, 
                 avatar: store.user.avatar, 
                 content: t, 
                 img: i, 
                 time: mId,
                 likes: [],
                 comments: []
             });
             save(); renderMoments();
             
             const contacts = store.contacts.sort(() => 0.5 - Math.random()).slice(0, 3);
             contacts.forEach((c, idx) => {
                 setTimeout(() => {
                    aiGenerate(`comment_user_moment::${c.id}::${mId}::${t.substring(0,20)}`);
                 }, 2000 * (idx + 1));
             });
        }
        
        function deleteMoment(idx) {
            if(confirm("确定删除?")) { 
                store.moments.splice(idx,1); 
                save(); renderMoments(); 
            }
        }
        
        function toggleLike(idx) {
            const m = store.moments[idx];
            if(!m.likes) m.likes = [];
            
            if(m.likes.includes('me')) {
                m.likes = m.likes.filter(x=>x!=='me');
            } else {
                m.likes.push('me');
            }
            save(); renderMoments();
        }
        
        function addComment(idx) {
            const t = prompt("评论:");
            if(t) {
                const m = store.moments[idx];
                if(!m.comments) m.comments = [];
                m.comments.push({name:store.user.name, text:t, replyTo: m.name});
                save(); renderMoments();
                
                const contact = store.contacts.find(c => c.name === m.name);
                // Only trigger AI reply if the moment author is not the user
                if(contact && m.name !== store.user.name) {
                    setTimeout(() => {
                        // reply_moment_comment::contactId(author)::momentId::commentText::commentAuthor
                        aiGenerate(`reply_moment_comment::${contact.id}::${m.id}::${t}::${store.user.name}`);
                    }, 1000);
                }
            }
        }

        // --- ME ---
        function openProfileEdit() {
             document.getElementById('p-edit-name').value = store.user.name;
             document.getElementById('p-edit-wxid').value = store.user.wxid;
             document.getElementById('modal-profile-edit').style.display='flex';
        }
        function saveProfileEdit() {
             store.user.name = document.getElementById('p-edit-name').value;
             store.user.wxid = document.getElementById('p-edit-wxid').value;
             save(); document.getElementById('my-name').innerText=store.user.name;document.getElementById('my-wxid').innerText=store.user.wxid;
             document.getElementById('modal-profile-edit').style.display='none';
        }
        function openWallet() {document.getElementById('layer-wallet').classList.add('show');
            document.getElementById('wallet-amt').innerText = store.user.balance.toFixed(2);
            const bills = store.bills || [];
            document.getElementById('wallet-bill').innerHTML = bills.map(b=>`<div class="list-item"><div class="list-title">${b.desc}</div><div class="list-sub">${b.type==='out'?'-':'+'}${b.amt}</div></div>`).join('');}

        // --- PERSONA MGMT ---
        function openPersonaMgmt() {document.getElementById('layer-persona-mgmt').classList.add('show'); renderPersonas(); }
        function openPersonaModal() { document.getElementById('modal-persona').style.display='flex'; }
        function saveNewPersona() {
             const n = document.getElementById('new-p-name').value;
             constd = document.getElementById('new-p-desc').value;
             const img = document.getElementById('new-persona-img').src;
             if(!n) return toast("请输入名称");
             store.personas.push({id:'p'+Date.now(), name:n, desc:d, avatar:img});
             save(); renderPersonas(); document.getElementById('modal-persona').style.display='none';
        }
        function renderPersonas() {
             const l = document.getElementById('persona-list'); l.innerHTML = '';
             store.personas.forEach(p => l.innerHTML += `<div class="group-box" style="padding:15px; display:flex; align-items:center;"><img src="${p.avatar||'https://via.placeholder.com/50'}" class="avatar" style="margin-right:10px;"><div><strong>${p.name}</strong><p>${p.desc}</p></div></div>`);
        }

        // --- WORLD BOOK ---
        function openWBModal() { 
            document.getElementById('modal-wb').style.display='flex'; 
            updateCategorySelect();
        }
        function openCategoryModal() {document.getElementById('modal-category').style.display='flex';
        }
        function saveCategory() {
            const name = document.getElementById('new-category-name').value;
            if(!name) return toast("请输入分类名称");
            if(!store.categories) store.categories = [];
            store.categories.push(name);
            save(); 
            document.getElementById('modal-category').style.display='none';toast("分类已创建");
            updateCategorySelect();
        }
        function updateCategorySelect() {
            const sel = document.getElementById('new-wb-cate-sel');
            sel.innerHTML = '<option value="">无分类</option>';
            (store.categories||[]).forEach(c => {
                sel.innerHTML += `<option value="${c}">${c}</option>`;
            });
        }
        function saveNewWorldBook() {
             const n = document.getElementById('new-wb-name').value;
             const c = document.getElementById('new-wb-content').value;
             const cate = document.getElementById('new-wb-cate-sel').value;
             if(!n) return toast("请输入名称");
             if(!store.worldbooks) store.worldbooks = [];
             store.worldbooks.push({id:'wb'+Date.now(), name:n, content:c, cate});
             save(); renderWorldBooks(); document.getElementById('modal-wb').style.display='none';
        }
        let activeWBCategory = 'all';

        function renderWorldBooks() {
             // Render Category Bar
             const catBar = document.getElementById('wb-category-bar');
             const categories = ['全部', ...(store.categories || [])];
             catBar.innerHTML = categories.map((c, i) => {
                 const val = i===0 ? 'all' : c;
                 return `<div class="wb-cate-chip ${activeWBCategory===val?'active':''}" onclick="filterWorldBook('${val}')">${c}</div>`;
             }).join('');

             // Render List
             const l = document.getElementById('wb-list'); 
             l.innerHTML='';
             
             let list = store.worldbooks || [];
             if(activeWBCategory !== 'all') {
                 list = list.filter(w => w.cate === activeWBCategory);
             }
             
             if(list.length === 0) {
                 l.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">暂无内容</div>';
             } else {
                 list.forEach(w => l.innerHTML += `<div class="group-box" style="padding:15px;"><strong>${w.name}</strong> ${w.cate?`<span style="background:#f0f0f0; padding:2px 8px; border-radius:4px; font-size:12px; margin-left:5px;">${w.cate}</span>`:''}<p style="margin-top:8px;">${w.content}</p></div>`);
             }
        }
        
        function filterWorldBook(cat) {
            activeWBCategory = cat;
            renderWorldBooks();
        }

        // --- COUPLE ---
        function openCoupleSelector() {
            coupleViewMode = 'selector';
            renderCouple();
        }
        
        function gotoCoupleDetail() {
            coupleViewMode = 'detail';
            renderCouple();
        }

        function renderCouple() {
            if(!store.couple) store.couple = { partnerId: null, start: '', wishes: [], anniversaries: [], cycleDate:'', cycleLen:28 };
            
            const area = document.getElementById('couple-content-area');
            if(!area) return;
            area.innerHTML = '';

            if (coupleViewMode === 'list') {
                 let html = `
                    <div class="nav-bar" style="background:#ededed; color:#000; position:relative; margin-top:54px;">
                        <div class="nav-icon" onclick="exitApp()"><i class="fas fa-chevron-left"></i></div>
                        <div class="nav-title">情侣空间</div>
                        <div class="nav-icon" onclick="openCoupleSelector()"><i class="fas fa-plus"></i></div>
                    </div>
                    <div class="scroll-y" style="background:#f2f2f2; padding:20px;">
                 `;
                 
                 if (store.couple.partnerId) {
                     const p = store.contacts.find(x=>x.id===store.couple.partnerId);
                     const days = store.couple.start ? Math.floor((new Date() - new Date(store.couple.start))/(1000*60*60*24)) : 0;
                     html += `
                        <div onclick="gotoCoupleDetail()" style="background:#fff; border-radius:12px; padding:20px; display:flex; align-items:center; box-shadow:0 2px 10px rgba(0,0,0,0.05);">
                             <div style="position:relative;">
                                 <img src="${store.user.avatar||'https://via.placeholder.com/50'}" style="width:50px; height:50px; border-radius:50%; border:2px solid #fff;">
                                 <img src="${p?p.avatar:'https://via.placeholder.com/50'}" style="width:50px; height:50px; border-radius:50%; border:2px solid #fff; margin-left:-15px;">
                             </div>
                             <div style="margin-left:15px; flex:1;">
                                 <div style="font-weight:bold; font-size:16px;">我和${p?p.name:'TA'}</div>
                                 <div style="color:#ff758c; font-size:13px; margin-top:5px;">已相爱 ${days} 天</div>
                             </div>
                <i class="fas fa-chevron-right" style="color:#ccc;"></i>
                        </div>
                     `;
                 } else {
                     html += `<div style="text-align:center; color:#999; margin-top:100px;">暂无情侣关系<br>点击右上角建立</div>`;
                 }
                 html += `</div>`;
                 area.innerHTML = html;
                } else if (coupleViewMode === 'selector') {
                 let html = `
                    <div class="nav-bar" style="background:#fff; color:#000; position:relative; margin-top:64px;">
                        <div class="nav-icon" onclick="coupleViewMode='list';renderCouple()"><i class="fas fa-chevron-left"></i></div>
                        <div class="nav-title">选择另一半</div>
                        <div class="nav-icon"></div>
                    </div>
                    <div class="scroll-y" style="background:#f2f2f2; padding:15px;">
                        <div style="color:#777; margin-bottom:10px; font-size:13px; padding-left:5px;">选择联系人建立关系</div>
                        ${store.contacts.map(c=>`
                            <div class="list-item" onclick="bindCouple('${c.id}')" style="border-radius:12px; margin-bottom:10px;">
                                <img src="${c.avatar}" class="avatar">
                                <div class="list-content"><div class="list-title">${c.name}</div></div>
                                <i class="fas fa-heart" style="color:#e5e5e5;"></i>
                            </div>`).join('')}
                    </div>
                 `;
                 area.innerHTML = html;

            } else if (coupleViewMode === 'detail') {
                const days = store.couple.start ? Math.floor((new Date() - new Date(store.couple.start))/(1000*60*60*24)) : 0;
                let html = `
                    <div class="nav-bar" style="background:transparent; position:absolute; top:54px; width:100%; border:none; color:#fff; z-index:100;">
                        <div class="nav-icon" onclick="coupleViewMode='list';renderCouple()" style="color:#fff;"><i class="fas fa-chevron-left"></i></div>
                        <div class="nav-title" style="color:#fff; font-size:20px; font-weight:bold;">情侣空间</div>
                        <div class="nav-icon" style="color:#fff;" onclick="toggleAddMenu(event, 'couple')"><i class="fas fa-cog"></i></div>
                    </div>
                     <div class="add-menu" id="couple-add-menu">
                        <div class="add-item" onclick="openCoupleDateModal()">设置开始日期</div>
                        <div class="add-item" onclick="openAnniversaryModal()">添加纪念日</div>
                        <div class="add-item" onclick="unbindCouple()">解除关系</div>
                    </div>
                    <div class="scroll-y" style="background:#f2f2f2;">
                        <div class="couple-pink-header">
                            <div style="font-size:18px; opacity:0.9; margin-bottom:5px;">我们在一起</div>
                            <div class="couple-days-num">${days}</div>
                            <div style="font-size:18px; opacity:0.9;">天</div>
                        </div>
                        <div class="couple-card"><h3 style="margin:0 0 15px; color:#ff758c;"><i class="fas fa-venus"></i> 经期助手</h3>
                             <div class="group-box" style="margin:0 0 20px; border:1px solid #ffeef1; background:#fffafa;"><div class="form-cell"><span class="form-label">最近经期</span><input type="date" id="cycle-date" class="form-val" style="border:none; background:transparent;" value="${store.couple.cycleDate}" onchange="updateCycle(this.value)"></div><div class="form-cell"><span class="form-label">周期长度</span><input type="number" id="cycle-len" class="form-val" value="${store.couple.cycleLen}" style="border:none; width:50px; background:transparent;"> 天</div></div>
                             
                             <h3 style="margin:0 0 15px; color:#ff758c;"><i class="fas fa-gift"></i> 纪念日</h3>
                             <div style="margin-bottom:20px;">
                                 ${(store.couple.anniversaries||[]).length === 0 ? '<div style="color:#999; text-align:center; padding:10px;">暂无纪念日</div>' : ''}
                                 ${(store.couple.anniversaries||[]).map(a=>`<div class="list-item" style="border-radius:12px; margin-bottom:8px; border:1px solid #eee;"><div class="list-title">${a.name}</div><div class="list-sub" style="margin-left:auto;">${a.date}<span style="font-size:12px; background:#ffeef1; color:#ff758c; padding:2px 6px; border-radius:4px;">${a.repeat==='year'?'每年':'一次'}</span></div></div>`).join('')}
                             </div>
                             
                             <h3 style="margin:0 0 15px; color:#ff758c; display:flex; justify-content:space-between; align-items:center;"><span><i class="fas fa-star"></i> 心愿单</span> <i class="fas fa-plus-circle" style="cursor:pointer;" onclick="openCustomInput('wish')"></i></h3>
                             <div>
                                ${(store.couple.wishes||[]).length === 0 ? '<div style="color:#999; text-align:center; padding:10px;">许个愿吧~ AI会帮你规划</div>' : ''}
                                ${(store.couple.wishes||[]).map(w=>`
                                    <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:10px; border-left:4px solid ${w.author==='me'?'#ff758c':'#a18cd1'};">
                                        <div style="font-size:15px; color:#333; margin-bottom:8px;">${w.text}</div>
                                        ${w.reply ? `<div style="background:#fff; padding:10px; border-radius:8px; font-size:13px; color:#666; display:flex; gap:8px;"><i class="fas fa-robot" style="color:#ff758c; margin-top:2px;"></i><div>${w.reply}</div></div>` : ''}
                                    </div>
                                `).join('')}
                             </div>
                        </div>
                    </div>
                `;
                area.innerHTML = html;
            }
        }
        
        function bindCouple(id) {
            store.couple.partnerId = id;
            store.couple.start = new Date().toISOString();
            save(); 
            coupleViewMode = 'detail';
            renderCouple();
        }
        function unbindCouple() { 
            if(confirm("解除关系?")) { 
                store.couple = {partnerId:null, start:'', cycleDate:'', anniversaries:[], wishes:[]}; 
                save(); coupleViewMode='list'; renderCouple(); 
            } 
        }
        function openCoupleDateModal() {
            document.getElementById('modal-couple-date').style.display='flex';
            if(store.couple.start) {
                document.getElementById('couple-start-date').value = store.couple.start.split('T')[0];
            }
        }
        function saveCoupleStartDate() {
            const dateVal = document.getElementById('couple-start-date').value;
            if(dateVal) {
                store.couple.start = new Date(dateVal).toISOString();
                save(); renderCouple();
                document.getElementById('modal-couple-date').style.display='none';
                toast("日期已设置");
            }
        }
        function updateCycle(v) { store.couple.cycleDate=v; save(); }
        function openAnniversaryModal() { document.getElementById('modal-anniv').style.display='flex'; }
        function saveAnniversary() {const n = document.getElementById('ani-name').value;
             const d = document.getElementById('ani-date').value;
             const r = document.getElementById('ani-repeat').value;
             if(!n || !d) return toast("请填写完整信息");
             if(!store.couple.anniversaries) store.couple.anniversaries = [];
             store.couple.anniversaries.push({name:n, date:d, repeat:r});
             save(); renderCouple(); document.getElementById('modal-anniv').style.display='none';}

        // --- MUSIC (全局播放器) ---
        function openMusic() { 
            document.getElementById('layer-music').classList.add('show'); 
            renderMusicList(); 
        }
        function addMusicPopup() {document.getElementById('modal-music').style.display='flex'; }
        function showMusicInput(type) {document.getElementById('music-url-area').style.display = type==='url'?'block':'none';
             document.getElementById('music-local-area').style.display = type==='local'?'block':'none';}
        function confirmAddMusic() {
             if(document.getElementById('music-url-area').style.display==='block') {
                  const u = document.getElementById('music-url-in').value;
                  const n = document.getElementById('music-name-in').value ||'Music '+store.musics.length;
                  if(u) store.musics.push({name:n, url:u});}
             save(); renderMusicList(); document.getElementById('modal-music').style.display='none';
        }
        function renderMusicList() {
             const l = document.getElementById('music-list'); 
             if(!store.musics) store.musics = [];
             l.innerHTML='';
             store.musics.forEach((m,i)=>l.innerHTML+=`
                <div class="list-item">
                    <div class="list-title" style="flex:1;">${m.name}</div>
                    <button onclick="playMusicGlobal(${i})" style="padding:5px 15px; border:none; background:var(--primary); color:#fff; border-radius:4px;">播放</button>
                </div>
             `);
        }
        
        function playMusicGlobal(index) {
            if(!store.musics || store.musics.length === 0) return;
            currentMusicIndex = index;
            const m = store.musics[index];
            const audio = document.getElementById('global-audio');
            const player = document.getElementById('global-music-player');
            const title = document.getElementById('current-music-title');
            const btn = document.getElementById('play-pause-btn');
            
            audio.src = m.url;
            title.innerText = m.name;
            player.style.display = 'flex';
            audio.play();
            btn.className = 'fas fa-pause';
        }
        
        function togglePlay() {
            const audio = document.getElementById('global-audio');
            const btn = document.getElementById('play-pause-btn');
            if(audio.paused) {
                audio.play();
                btn.className = 'fas fa-pause';
            } else {
                audio.pause();
                btn.className = 'fas fa-play';
            }
        }
        
        function nextMusic() {
            if(!store.musics || store.musics.length === 0) return;
            currentMusicIndex = (currentMusicIndex + 1) % store.musics.length;
            playMusicGlobal(currentMusicIndex);
        }
        
        function prevMusic() {
            if(!store.musics || store.musics.length === 0) return;
            currentMusicIndex = (currentMusicIndex - 1 + store.musics.length) % store.musics.length;
            playMusicGlobal(currentMusicIndex);
        }
        
        function closeMusic() {
            const audio = document.getElementById('global-audio');
            const player = document.getElementById('global-music-player');
            audio.pause();
            player.style.display = 'none';
        }

        // --- STICKERS ---
        function openStickerGallery() {
            // Migration check
            if(!store.stickerCategories) {
                store.stickerCategories = [{id:'default', name:'默认', stickers:[{url:'😀', type:'emoji'}]}];
                if(store.stickers && store.stickers.length > 0) {
                     store.stickerCategories[0].stickers = store.stickerCategories[0].stickers.concat(store.stickers.filter(s=>s.url!=='😀'));
                }
                store.stickers = []; 
                save();
            }
            
            document.getElementById('layer-stickers').classList.add('show'); 
            renderStickerCategories();
        }
        
        function openStickerMenu(e) {
            e.stopPropagation();
            const el = document.getElementById('sticker-menu');
            document.querySelectorAll('.add-menu').forEach(m => { if(m.id !== el.id) m.style.display = 'none'; });
            el.style.display = el.style.display==='flex'?'none':'flex';
        }

        function addStickerCategoryPopup() {
            document.getElementById('modal-sticker-cate').style.display='flex';
            document.getElementById('sticker-menu').style.display='none';
        }
        
        function saveStickerCategory() {
            const n = document.getElementById('new-sticker-cate-name').value;
            if(!n) return toast("请输入分类名");
            store.stickerCategories.push({id:'sc'+Date.now(), name:n, stickers:[]});
            save(); renderStickerCategories(); document.getElementById('modal-sticker-cate').style.display='none';
            toast("分类已创建");
        }

        function addStickerPopup() { 
            const s = document.getElementById('sticker-add-cate-sel');
            s.innerHTML = store.stickerCategories.map(c=>`<option value="${c.id}" ${c.id===activeStickerCateId?'selected':''}>${c.name}</option>`).join('');
            document.getElementById('modal-sticker').style.display='flex'; 
            document.getElementById('sticker-menu').style.display='none';
        }
        
        function showStickerInput(type) {
            document.getElementById('sticker-url-area').style.display = type==='url'?'block':'none';
            document.getElementById('sticker-local-area').style.display = type==='local'?'block':'none';
        }
        
        function confirmAddSticker() {
            const targetCateId = document.getElementById('sticker-add-cate-sel').value;
            const cate = store.stickerCategories.find(c=>c.id===targetCateId);
            if(!cate) return;

            if(document.getElementById('sticker-url-area').style.display==='block') {
                const u = document.getElementById('sticker-url-in').value;
                if(u) cate.stickers.push({url:u, type:'image'});
            }
            save(); 
            if(activeStickerCateId === targetCateId) renderStickerGallery(); 
            document.getElementById('modal-sticker').style.display='none';
            toast("表情已添加");
        }
        
        function renderStickerCategories() {
            const sb = document.getElementById('sticker-categories');
            sb.innerHTML = '';
            store.stickerCategories.forEach(c => {
                sb.innerHTML += `<div class="sticker-cate-tab ${activeStickerCateId===c.id?'active':''}" onclick="switchStickerCate('${c.id}')">${c.name}</div>`;
            });
            renderStickerGallery();
        }
        
        function switchStickerCate(id) {
            activeStickerCateId = id;
            renderStickerCategories(); // Re-render to update active state
        }

        function renderStickerGallery() {
            const g = document.getElementById('sticker-gallery-grid'); 
            g.innerHTML='';
            const cate = store.stickerCategories.find(c=>c.id===activeStickerCateId);
            if(cate) {
                cate.stickers.forEach(s => g.innerHTML+=`<div class="sticker-item">${s.type==='emoji'?s.url:`<img src="${s.url}" onclick="showBigImg('${s.url}')">`}</div>`);
            }
        }
        
        function showBigImg(url) {
            document.getElementById('big-img-el').src = url;
            document.getElementById('modal-big-img').style.display = 'flex';
        }

        // --- PERCEPTION ---
        function savePerception() {
             const p = store.perception;
             p.master = document.getElementById('perc-master').checked;
             
             p.customDate = document.getElementById('perc-custom-date').checked;
             p.dateVal = document.getElementById('perc-date-val').value;
             
             p.customTime = document.getElementById('perc-custom-time').checked;
             p.timeVal = document.getElementById('perc-time-val').value;
             
             p.customCity = document.getElementById('perc-custom-city').checked;
             p.cityVal = document.getElementById('perc-city-val').value;
             p.realCityVal = document.getElementById('perc-real-city-val').value;
             
             p.customWeather = document.getElementById('perc-custom-weather').checked;
             p.weatherVal = document.getElementById('perc-weather-val').value;
             
             p.customClimate = document.getElementById('perc-custom-climate').checked;
             
             save();
             renderPerception();
        }

        function renderPerception() {
             const p = store.perception;
             
             // Update Card Display (Real or Virtual based on settings)
             // If master is OFF, we assume "Real World" implicitly or just "No Perception"? 
             // Requirement says: "Switch ON => read settings". "Switch OFF => close all perception".
             // Actually requirement 4.4 says "Master switch, one click close all...". 
             // Requirement 4.3 says "If user not set virtual info... can still read real time/date".
             
             // Let's determine "Effective" Display
             let displayWeather = "未知";
             let displayTemp = "";
             let displayLoc = "未知";
             
             if (p.master) {
                 if (p.customWeather && p.weatherVal) {
                     displayWeather = p.weatherVal;
                     displayTemp = ""; // Custom weather text usually doesn't have temp unless user types it
                 } else {
                     // Real weather (simulated or API)
                     displayWeather = p.weather || '晴朗';
                     displayTemp = p.temp || '26°C';
                 }
                 
                 if (p.customCity && p.cityVal) {
                     displayLoc = p.cityVal;
                 } else {
                     displayLoc = "现实位置"; // Or user's real city if we had GPS, here just placeholder
                 }
             } else {
                 displayWeather = "感知已关闭";
                 displayTemp = "--";
                 displayLoc = "--";
             }

             document.getElementById('perc-weather').innerText = displayWeather;
             document.getElementById('perc-weather-temp').innerText = displayTemp;
             document.getElementById('perc-loc').innerText = displayLoc;

             // Controls
             document.getElementById('perc-master').checked = p.master;
             
             document.getElementById('perc-custom-date').checked = p.customDate;
             document.getElementById('perc-date-val').value = p.dateVal;
             document.getElementById('perc-date-val').disabled = !p.customDate;
             
             document.getElementById('perc-custom-time').checked = p.customTime;
             document.getElementById('perc-time-val').value = p.timeVal;
             document.getElementById('perc-time-val').disabled = !p.customTime;
             
             document.getElementById('perc-custom-city').checked = p.customCity;
             document.getElementById('perc-city-val').value = p.cityVal || '';
             document.getElementById('perc-real-city-val').value = p.realCityVal || '';
             document.getElementById('perc-city-val').disabled = !p.customCity;
             document.getElementById('perc-real-city-val').disabled = !p.customCity;

             document.getElementById('perc-custom-weather').checked = p.customWeather;
             document.getElementById('perc-weather-val').value = p.weatherVal || '';
             document.getElementById('perc-weather-val').disabled = !p.customWeather;

             document.getElementById('perc-custom-climate').checked = p.customClimate;
             document.getElementById('perc-climate-val').innerText = p.climateVal || '点击选择';
             document.getElementById('perc-climate-val').style.color = p.customClimate ? '#333' : '#aaa';
             document.getElementById('perc-climate-val').style.pointerEvents = p.customClimate ? 'auto' : 'none';

             const l = document.getElementById('festival-list'); l.innerHTML='';
             (p.festivals||[]).forEach(f => l.innerHTML+=`<div class="list-item"><div class="list-title">${f.name}</div><div class="list-sub">${f.date}</div></div>`);
        }

        function selectClimate(c) {
            store.perception.climateVal = c; 
            save(); 
            renderPerception(); 
            document.getElementById('modal-picker').style.display='none';
        }
        function picker(type) {
            if(type==='climate') {
                const opts = ['热带雨林','热带草原','热带沙漠','亚热带季风','地中海','温带海洋','温带季风','温带大陆','极地'];
                const p = document.getElementById('modal-picker');
                const l = document.getElementById('picker-list');
                document.getElementById('picker-title').innerText = "选择气候";
                l.innerHTML = opts.map(o=>`<div class="list-item" onclick="selectClimate('${o}')">${o}</div>`).join('');
                p.style.display='flex';
            }}
        function selectClimate(c) {
            store.perception.climate = c; save(); renderPerception(); document.getElementById('modal-picker').style.display='none';
        }

        // --- CHECK PHONE CORE ---
        async function aiGeneratePhone(type, context) {
            document.getElementById('loading').style.display = 'block';
            try {
                let sysPrompt = "You are an AI generating realistic content for a simulated 'Phone Check' game.";
                let prompt = "";
                let targetName = activeCheckPhoneContactName || "Someone";
                
                let targetC = null;
                if (activeCheckPhoneContactName) {
                    targetC = store.contacts.find(x => x.name === activeCheckPhoneContactName);
                } else if (store.couple.partnerId) {
                    targetC = store.contacts.find(x => x.id === store.couple.partnerId);
                }
                
                if (targetC) {
                    sysPrompt += ` Target Persona: ${targetC.name}, ${targetC.persona}.`;
                    targetName = targetC.name;
                }

                if(type === 'contacts') prompt = `Generate 8 realistic contact names for ${targetName}'s phone. Use Chinese. Format: [CONTACT:Name]`;
                if(type === 'chat') prompt = `Generate realistic WeChat chat between '${targetName}' (as 'Me') and '${context}' on ${targetName}'s phone. 8-15 messages. Use Chinese. Format: [MSG:Time|Sender|Content]`;
                if(type === 'memo') prompt = `Generate 5 realistic phone memos for ${targetName}. Mix of tasks and diary. Use Chinese. Format: [MEMO:Title|Date|Content]`;
                if(type === 'search') prompt = `Generate 8 realistic browser searches for ${targetName}. Use Chinese. Format: [SEARCH:Time|Query]`;

                const data = await API.chatCompletion([{role:'system', content:sysPrompt}, {role:'user', content:prompt}]);
                if (!data || !data.choices || data.choices.length === 0) throw new Error("Invalid response");
                const text = data.choices[0].message.content;

                if(type === 'contacts') {
                    store.phoneData.contacts = Array.from(text.matchAll(/\[CONTACT:(.*?)\]/g), m => ({name: m[1]}));
                    if(store.phoneData.contacts.length===0) store.phoneData.contacts = [{name:'Mom'},{name:'Ex'},{name:'Boss'}];
                }
                if(type === 'chat') {
                    store.phoneData.chats[context] = Array.from(text.matchAll(/\[MSG:(.*?)\|(.*?)\|(.*?)\]/g), m => ({time:m[1], sender:m[2], content:m[3]}));
                }
                if(type === 'memo') {
                    store.phoneData.memo = Array.from(text.matchAll(/\[MEMO:(.*?)\|(.*?)\|(.*?)\]/g), m => ({title:m[1], date:m[2], content:m[3]}));
                }
                if(type === 'search') {
                    store.phoneData.search = Array.from(text.matchAll(/\[SEARCH:(.*?)\|(.*?)\]/g), m => ({time:m[1], query:m[2]}));
                }
                
                save();
                document.getElementById('loading').style.display = 'none';
                return true;
            } catch(e) {
                console.error("aiGeneratePhone Error:", e);
                document.getElementById('loading').style.display = 'none';
                return false;
            }
        }

        // New Check Phone Entry Point
        function selectCheckPhoneContact() {
            const list = document.getElementById('checkphone-contact-list');
            list.innerHTML = store.contacts.map(c => 
                `<div class="list-item" onclick="startCheckPhone('${c.name}')">
                    <img src="${c.avatar}" class="avatar">
                    <div class="list-content"><div class="list-title">${c.name}</div></div>
                </div>`
            ).join('');
            document.getElementById('modal-checkphone-contact').style.display = 'flex';
        }

        function startCheckPhone(name) {
            activeCheckPhoneContactName = name;
            document.getElementById('modal-checkphone-contact').style.display = 'none';
            document.getElementById('checkphone-container').innerHTML = `
                 <div style="background:#fff; padding:15px; margin-bottom:10px; text-align:center;">
                     <div style="font-size:18px; font-weight:bold;">正在查看 ${name} 的手机</div>
                     <div style="font-size:12px; color:#999; margin-top:5px;">点击下方图标查看内容</div>
                 </div>
                 <div class="phone-grid">
                    <div class="phone-card" onclick="openPhoneFunc('contacts')" style="color:#07c160;"><i class="fas fa-address-book" style="font-size:40px; margin-bottom:15px;"></i><div style="font-size:16px; color:#333;">联系人</div></div>
                    <div class="phone-card" onclick="openPhoneFunc('memo')" style="color:#f6c02d;"><i class="fas fa-sticky-note" style="font-size:40px; margin-bottom:15px;"></i><div style="font-size:16px; color:#333;">备忘录</div></div>
                    <div class="phone-card" onclick="openPhoneFunc('search')" style="color:#1296db;"><i class="fas fa-search" style="font-size:40px; margin-bottom:15px;"></i><div style="font-size:16px; color:#333;">搜索记录</div></div>
                    <div class="phone-card" onclick="openPhoneFunc('usage')" style="color:#5856d6;"><i class="fas fa-chart-pie" style="font-size:40px; margin-bottom:15px;"></i><div style="font-size:16px; color:#333;">使用情况</div></div>
                </div>
                <button class="full-btn red" onclick="exitCheckPhone()">退出查看</button>
            `;
            // Clear old data to force refresh for new person
            store.phoneData = { contacts: [], memo: [], usage: [], search: [], chats: {} };
        }

        function exitCheckPhone() {
            activeCheckPhoneContactName = null;
            document.getElementById('checkphone-container').innerHTML = `
                 <div style="text-align:center; padding:50px; color:#999;">
                     <i class="fas fa-mobile-alt" style="font-size:64px; margin-bottom:20px; color:#ccc;"></i>
                     <div>请先选择要查看的联系人</div>
                     <button onclick="selectCheckPhoneContact()" style="margin-top:20px; padding:10px 25px; background:var(--primary); color:#fff; border:none; border-radius:6px; font-size:16px;">选择联系人</button>
                 </div>
            `;
            exitApp();
        }

        async function openPhoneFunc(type) {
             if(!activeCheckPhoneContactName) return toast("请先选择联系人");
             const layerMap = { contacts: 'layer-phone-contacts', memo: 'layer-phone-memo', search: 'layer-phone-search', usage: 'layer-phone-usage' };
             const el = document.getElementById(layerMap[type]);
             el.classList.add('show');
             if(type === 'contacts') {
                 if(!store.phoneData.contacts || store.phoneData.contacts.length === 0) await refreshPhoneData('contacts');
                 else renderPhoneContacts();
             }
             if(type === 'memo') {
                 if(!store.phoneData.memo || store.phoneData.memo.length === 0) await refreshPhoneData('memo');
                 else renderPhoneMemos();
             }
             if(type === 'search') {
                 if(!store.phoneData.search || store.phoneData.search.length === 0) await refreshPhoneData('search');
                 else renderPhoneSearch();
             }
             if(type === 'usage') renderPhoneUsage();
        }

        async function refreshPhoneData(type) {
             const success = await aiGeneratePhone(type);
             if(success) {
                 if(type==='contacts') renderPhoneContacts();
                 if(type==='memo') renderPhoneMemos();
                 if(type==='search') renderPhoneSearch();
             }
        }

        function renderPhoneContacts() {
             const l = document.getElementById('phone-contacts-list');
             l.innerHTML = (store.phoneData.contacts||[]).map(c =>`<div class="list-item" onclick="openPhoneChat('${c.name}')">
                    <div class="avatar" style="background:#ddd; display:flex; justify-content:center; align-items:center; color:#fff; font-weight:bold;">${c.name[0]}</div>
                    <div class="list-content"><div class="list-title">${c.name}</div></div>
                    <i class="fas fa-chevron-right" style="color:#ddd;"></i>
                 </div>`
             ).join('');
        }

        async function openPhoneChat(name) {
             document.getElementById('phone-chat-title').innerText = name;
             document.getElementById('layer-phone-chat').classList.add('show');
             
             if(!store.phoneData.chats) store.phoneData.chats = {};
             if(!store.phoneData.chats[name]) {
                 const success = await aiGeneratePhone('chat', name);
                 if(!success) return;
             }
             renderPhoneChat(name);
        }

        function renderPhoneChat(name) {
             const h = document.getElementById('phone-chat-history');
             h.innerHTML = '';
             const msgs = store.phoneData.chats[name] || [];
             msgs.forEach(m => {
                 const isMe = m.sender === 'Me' || m.sender === '我';
                 h.innerHTML += `
                    <div class="phone-chat-time">${m.time}</div>
                    <div class="msg-row ${isMe ? 'me' : ''}" style="margin:5px 0;">
                        <div class="avatar" style="width:40px; height:40px; border-radius:4px; background:${isMe?'#95ec69': '#fff'}; display:flex; justify-content:center; align-items:center; font-size:12px; border:1px solid #ddd;">${isMe?'我':name[0]}</div>
                        <div class="bubble" style="${isMe?'background:#95ec69; border-color:#8ad863;':'background:#fff;'}">${m.content}</div>
                    </div>
                 `;
             });
             h.scrollTop = h.scrollHeight;
        }

        function renderPhoneMemos() {
             const l = document.getElementById('phone-memo-list');
             l.innerHTML = (store.phoneData.memo||[]).map((m,i) => 
                 `<div class="memo-item" onclick="openMemoDetail(${i})">
                    <div class="memo-title">${m.title}</div>
                    <div class="memo-date">${m.date}</div>
                    <div style="font-size:13px; color:#666; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; margin-top:5px;">${m.content}</div>
                 </div>`
             ).join('');
        }

        function openMemoDetail(idx) {
             const m = store.phoneData.memo[idx];
             document.getElementById('memo-det-title').innerText = m.title;
             document.getElementById('memo-det-date').innerText = m.date;
             document.getElementById('memo-det-content').innerHTML = m.content;
             document.getElementById('phone-memo-detail').style.display = 'flex';
        }

        function renderPhoneSearch() {
             const l = document.getElementById('phone-search-list');
             l.innerHTML = (store.phoneData.search||[]).map(s => 
                 `<div class="browser-item">
                    <div class="browser-icon"><i class="fas fa-globe"></i></div>
                    <div class="browser-info">
                        <div class="browser-query">${s.query}</div>
                        <div class="browser-url">百度 • ${s.time}</div>
                    </div>
                    <i class="fas fa-angle-right" style="color:#ddd;"></i>
                 </div>`
             ).join('');
        }
        
        function renderPhoneUsage() {
            document.getElementById('phone-usage-content').innerHTML = `
                <div class="group-box" style="padding:20px; text-align:center;">
                    <div style="font-size:40px; font-weight:bold; color:#333;">4h20m</div>
                    <div style="color:#999; margin-top:5px;">今日屏幕使用时间</div>
                </div>
                <div class="group-box">
                    <div class="list-item"><div class="list-title" style="flex:1;">微信</div><div style="color:#888;">2h 10m</div></div>
                    <div class="list-item"><div class="list-title" style="flex:1;">抖音</div><div style="color:#888;">1h 05m</div></div>
                    <div class="list-item"><div class="list-title" style="flex:1;">浏览器</div><div style="color:#888;">45m</div></div>
                </div>
            `;
        }

        // --- BEAUTIFY ---
        function renderBeautify() {
             if(!store.appIcons) store.appIcons = { wechat:'', worldbook:'', couple:'', perception:'', checkphone:'', beauty:'', settings:'' };
             
             const grid = document.getElementById('beautify-grid');
             if(!grid) return;

             grid.innerHTML = 
                ['wechat','worldbook','couple','perception','checkphone','beauty','settings'].map(id => {
                    const icon = store.appIcons[id] || '';
                    const style = icon ? `background-image:url(${icon}); background-size:cover;` : 'background:#eee;';
                    return `<div style="display:flex; flex-direction:column; align-items:center;" onclick="changeAppIcon('${id}')">
                        <div style="width:50px; height:50px; border-radius:12px; ${style} display:flex; justify-content:center; align-items:center;">${icon?'':'<i class="fas fa-image"></i>'}</div>
                        <span style="font-size:12px; margin-top:5px;">${id}</span>
                    </div>`;
                }).join('');
        }
        function changeAppIcon(id) {tempImgTarget = 'icon-'+id;
             document.getElementById('file-input').click();
        }

        // --- DATA MGMT ---
        function exportData() {
            try {
                const blob = new Blob([JSON.stringify(store)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "AIChatOS_Backup_" + new Date().toISOString().slice(0,10) + ".json";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                toast("导出成功");
            } catch(e) {
                toast("导出失败: " + e.message);
            }
        }

        function handleImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.user && data.contacts !== undefined) {
                        store = data;
                        // Ensure appIcons exists
                        if(!store.appIcons) store.appIcons = { wechat:'', worldbook:'', couple:'', perception:'', checkphone:'', beauty:'', settings:'' };
                        save();
                        toast("数据导入成功，即将刷新...");
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        toast("无效的数据文件");
                    }
                } catch(err) {
                    toast("导入失败: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        // --- UTILS ---
        function textToImage(text, bgCol='#e0e0e0', textCol='#333') {
            const canvas = document.createElement('canvas');
            canvas.width = 600;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = bgCol;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = textCol;
            ctx.font = 'bold 40px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Simple text wrapping
            const maxWidth = 560;
            const lineHeight = 50;
            const words = text.split('');
            let line = '';
            let y = canvas.height / 2;
            
            // Check if text is too long, if so, wrap roughly (simplified)
            if (ctx.measureText(text).width > maxWidth) {
                 const charsPerLine = Math.floor(maxWidth / 40);
                 const lines = [];
                 for(let i=0; i<text.length; i+=charsPerLine) {
                     lines.push(text.substring(i, i+charsPerLine));
                 }
                 y = (canvas.height - (lines.length * lineHeight)) / 2 + (lineHeight/2);
                 lines.forEach((l, i) => {
                     ctx.fillText(l, canvas.width/2, y + (i*lineHeight));
                 });
            } else {
                ctx.fillText(text, canvas.width/2, y);
            }
            
            return canvas.toDataURL('image/png');
        }

        function uploadImg(target) {
            tempImgTarget=target; 
            const fi = document.getElementById('file-input');
            fi.value = '';
            fi.click(); 
        }document.getElementById('file-input').onchange = function(e) {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = (v) => {
                const u = v.target.result;
                if(tempImgTarget==='new-contact-avatar') {document.getElementById('new-contact-img').src=u; document.getElementById('new-contact-img').style.display='block'; }
                if(tempImgTarget==='edit-contact-avatar') { 
                    const c = store.contacts.find(x=>x.id===activeChatId);
                    if(c) { c.avatar = u; save(); openChatSettings(); }
                }
                if(tempImgTarget==='moment-bg') { store.user.momentBg = u; save(); renderMoments(); }
                if(tempImgTarget==='post-moment') postMoment(prompt("配文:")||'', u);
                if(tempImgTarget==='sticker-batch') { 
                    const cate = store.stickerCategories.find(c=>c.id===activeStickerCateId);
                    if(cate) cate.stickers.push({url:u, type:'image'});
                    save(); 
                    renderStickerGallery();
                }
                if(tempImgTarget==='music-file') { store.musics.push({name:f.name, url:u}); save(); }
                if(tempImgTarget==='desktop-bg') { store.desktopBg=u; save(); renderDesktop(); toast("主页背景已修改"); }
                if(tempImgTarget==='my-avatar') { store.user.avatar=u; save(); document.getElementById('my-avatar').src=u; }
                if(tempImgTarget==='chat-bg') { 
                    const c = store.contacts.find(x=>x.id===activeChatId);
                    if(c) { 
                        if(!c.settings) c.settings={}; 
                        c.settings.bg=u; 
                        save(); 
                        // Update background immediately if chat is open
                        if(activeChatId === c.id) {
                            document.getElementById('chat-history').style.backgroundImage = `url(${u})`;
                        }
                        toast("聊天背景应用成功");
                    }
                }
                if(tempImgTarget==='send-photo') userSend('image', u);
                if(tempImgTarget==='new-persona-avatar') { document.getElementById('new-persona-img').src=u; document.getElementById('new-persona-img').style.display='block'; }
                if(tempImgTarget.startsWith('icon-')) { 
                    const appId = tempImgTarget.replace('icon-','');
                    if(!store.appIcons) store.appIcons = { wechat:'', worldbook:'', couple:'', perception:'', checkphone:'', beauty:'', settings:'' };
                    store.appIcons[appId] = u; 
                    save(); 
                    renderDesktop(); 
                    renderBeautify(); 
                    toast("图标已修改");
                }
            };
            r.readAsDataURL(f);
        }
        
        function testLink(id, type) {
            const u = document.getElementById(id).value;
            if(!u) return toast("请输入链接");
            if(type==='audio') { const a=new Audio(u); a.onloadedmetadata=()=>toast("有效"); a.onerror=()=>toast("无效"); }
            else { const i=new Image(); i.onload=()=>toast("有效"); i.onerror=()=>toast("无效"); i.src=u; }
        }

        // --- NEW FEATURES LOGIC ---

        // Offline Mode
        let offlineSettings = {
            mode: 'page',
            minWords: 300,
            maxWords: 1000,
            style: '故事化'
        };

        function openOfflineMode() {
            exitApp();
            setTimeout(() => {
                document.getElementById('layer-offline-mode').classList.add('show');
                renderOfflineChat();
            }, 10);
            const extMenu = document.getElementById('ext-menu');
            if (extMenu) extMenu.style.display = 'none';
        }

        function openOfflineSettings() {
            document.getElementById('offline-mode-type').value = offlineSettings.mode;
            document.getElementById('offline-min-words').value = offlineSettings.minWords;
            document.getElementById('offline-max-words').value = offlineSettings.maxWords;
            document.getElementById('offline-style').value = offlineSettings.style;
            document.getElementById('modal-offline-settings').style.display = 'flex';
        }

        function saveOfflineSettings() {
            offlineSettings.mode = document.getElementById('offline-mode-type').value;
            offlineSettings.minWords = parseInt(document.getElementById('offline-min-words').value) || 300;
            offlineSettings.maxWords = parseInt(document.getElementById('offline-max-words').value) || 1000;
            offlineSettings.style = document.getElementById('offline-style').value;
            document.getElementById('modal-offline-settings').style.display = 'none';
            toast('设置已保存');
        }
        
        function renderOfflineChat() {
            const historyContainer = document.getElementById('offline-chat-history');
            if (!historyContainer) return;
            historyContainer.innerHTML = '';
            if (!store.offlineChat) store.offlineChat = [];

            store.offlineChat.forEach((msg, index) => {
                const isUser = msg.sender === 'user';
                const now = new Date(msg.time);
                const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
                
                const box = document.createElement('div');
                box.className = 'offline-msg-box';
                box.innerHTML = `
                    <div class="offline-msg-header ${isUser ? 'user' : ''}">
                        <div class="offline-sender">
                            <img src="${isUser ? (store.user.avatar || 'https://via.placeholder.com/50') : 'https://ui-avatars.com/api/?name=AI&background=random&color=fff'}" class="avatar">
                            <span>${isUser ? store.user.name : 'AI 助手'}</span>
                        </div>
                        <div class="offline-meta">
                            <span>${timeStr}</span>
                            <i class="fas fa-edit edit-icon" onclick="editOfflineMessage(${index})"></i>
                        </div>
                    </div>
                    <div class="offline-msg-body" id="offline-msg-body-${index}">
                        ${msg.content}
                    </div>
                `;
                historyContainer.appendChild(box);
            });

            historyContainer.scrollTop = historyContainer.scrollHeight;
        }

        function sendOfflineMessage() {
            const input = document.getElementById('offline-chat-input');
            const text = input.value.trim();
            if (!text) return;

            if (!store.offlineChat) store.offlineChat = [];
            store.offlineChat.push({ sender: 'user', content: text, time: Date.now() });
            
            // Add a placeholder for AI response
            store.offlineChat.push({ sender: 'ai', content: '正在生成中...', time: Date.now() });
            save();
            renderOfflineChat();
            
            input.value = '';

            // Call AI generation
            generateOfflineReply(text);
        }

        async function generateOfflineReply(userInput) {
            if(!store.system.key) {
                const lastMsg = store.offlineChat[store.offlineChat.length - 1];
                lastMsg.content = "错误：请先配置API Key";
                save();
                renderOfflineChat();
                return;
            }
            
            const responseText = await getOfflineTextFromAI(userInput);
            
            const lastMsg = store.offlineChat[store.offlineChat.length - 1];
            if (lastMsg && lastMsg.sender === 'ai') {
                lastMsg.content = responseText;
                save();
                renderOfflineChat();
            }
        }
        
        async function getOfflineTextFromAI(userInput) {
             try {
                const systemContent = `You are a creative writer. Based on the user's input, write a long-form text in a "${offlineSettings.style}" style. The word count should be between ${offlineSettings.minWords} and ${offlineSettings.maxWords} words. The output should be pure text without any special formatting tags.`;
                const messages = [
                    { role: "system", content: systemContent },
                    { role: "user", content: userInput }
                ];
                const data = await API.chatCompletion(messages);
                if (!data || !data.choices || data.choices.length === 0) {
                    throw new Error("Invalid API response");
                }
                return data.choices[0].message.content;
             } catch(e) {
                console.error("getOfflineTextFromAI error", e);
                return "生成失败: " + e.message;
             }
        }

        function regenerateOfflineReply() {
            if (!store.offlineChat || store.offlineChat.length < 2) return toast('没有可重新生成的内容');
            
            const lastUserMsg = store.offlineChat.slice().reverse().find(m => m.sender === 'user');
            if (!lastUserMsg) return toast('找不到上一条用户消息');

            const lastAiMsgIndex = store.offlineChat.length - 1;
            const lastAiMsg = store.offlineChat[lastAiMsgIndex];
            if (lastAiMsg.sender !== 'ai') return toast('最后一条消息不是AI回复');

            lastAiMsg.content = '正在重新生成...';
            save();
            renderOfflineChat();

            generateOfflineReply(lastUserMsg.content);
        }

        function editOfflineMessage(index) {
            const msg = store.offlineChat[index];
            if (!msg) return;

            const newContent = prompt('编辑消息内容:', msg.content);
            if (newContent !== null) {
                msg.content = newContent;
                save();
                renderOfflineChat();
                
                if (msg.sender === 'user' && store.offlineChat[index + 1] && store.offlineChat[index + 1].sender === 'ai') {
                    const aiMsg = store.offlineChat[index + 1];
                    aiMsg.content = '正在根据修改重新生成...';
                    save();
                    renderOfflineChat();
                    generateOfflineReply(newContent);
                }
            }
        }

        // Moments AI Interaction
        let aiMomentInteractionEnabled = false;

        function toggleAiMomentInteraction(enabled) {
            aiMomentInteractionEnabled = enabled;
            // This is a session-only setting as per current implementation.
            // To make it persistent, we would add it to the 'store' object and save().
            toast('朋友圈AI互评已' + (enabled ? '开启' : '关闭'));
        }

        // --- INIT ---
        if(store.user.avatar) document.getElementById('my-avatar').src=store.user.avatar;
        document.getElementById('my-name').innerText=store.user.name;
        document.getElementById('my-wxid').innerText=store.user.wxid;
        
        // Time Loop
        setInterval(() => {
            const now = new Date();document.getElementById('clock').innerText = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;}, 1000);

    </script>
</body>
</html>
